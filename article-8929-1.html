<!doctype html><html lang="en"><head><meta name="msvalidate.01" content="D404690CEFCB54C7762AC84935B99171"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6618da70c90c8744eead2e9371fb5077";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,s,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/s5f3f0tojf",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/theme.css"><link rel="shortcut icon" href="/favicon.png"><title>详解 Ubuntu snap 包的制作过程 - 归墟星火集</title><meta name="generator" content="Hexo 7.3.0"></head><body><div class="header-title"><span class="header-light"></span> <span class="header-light"></span> <span class="header-light"></span> <span>归墟星火集 linuxcn.undefined.today<span></span></span></div><div class="container"><ul class="nav"><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li><li><a target="_blank" rel="noopener" href="https://undefined.today/">Blog</a></li></ul><div class="content"><div class="post-container"><div class="post-header"><span class="ui-tips">标题：</span><h1 class="ui-keyword post-title">详解 Ubuntu snap 包的制作过程</h1><span class="post-date">2017-10-04</span></div><div class="post-header"><span class="ui-tips">分类：</span> <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></div><div class="post-header"><span class="ui-tips">标签：</span> <a href="/tags/Snap/">Snap</a></div><div class="post-content"><blockquote><p>如果你看过译者以前翻译的 snappy 文章，不知有没有感觉相关主题都是浅尝辄止，讲得不够透彻，看得也不太过瘾？如果有的话，相信这篇详细讲解如何从零开始制作一个 snap 包的文章应该不会让你失望。</p></blockquote><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005358bmfkk33gzwmfwtkf.jpg"></p><p>在这篇文章中，我们将看到如何为名为 <a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 的实用程序制作对应的 snap 包。如果这是你第一次听说 snap 安装包，你可以先看看 <a target="_blank" rel="noopener" href="https://tutorials.ubuntu.com/tutorial/create-your-first-snap">如何创建你的第一个 snap 包</a>。</p><p>今天我们将学习以下有关使用 snapcraft 制作 snap 包的内容：</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 源码中的 Makefile 文件是手工编写，我们需要修改一些 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/make">make 插件参数</a>。</li><li>这个程序是用 C++ 语言写的，依赖几个额外的库文件。我们需要把相关的代码添加到 snap 包中。</li><li><a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/confinement">严格限制还是传统限制</a>？我们将会讨论如何在它们之间进行选择。</li></ul><p>首先，我们了解下 <a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 有什么用？</p><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>Linux 终端模拟器已经变得非常炫酷，并且还能显示颜色！</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005427sz50aoivjjctwxuh.png" alt="1.png-19.9kB"></p><p>除了标准的颜色，大多数终端模拟器（如上图显示的 GNOME 终端）都支持真彩色（1600 万种颜色）。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005428jpmp2g9xdgwdgf12.png" alt="图片.png-61.9kB"></p><p>是的！终端模拟器已经支持真彩色了！从这个页面“ <a target="_blank" rel="noopener" href="https://gist.github.com/XVilka/8346728">多个终端和终端应用程序已经支持真彩色（1600 万种颜色）</a>” 可以获取 AWK 代码自己进行测试。你可以看到在代码中使用了一些 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Escape_sequence">转义序列</a> 来指定 RGB 的值（256 * 256 * 256 ~&#x3D; 1600 万种颜色）。</p><h3 id="timg-是什么？"><a href="#timg-是什么？" class="headerlink" title="timg 是什么？"></a>timg 是什么？</h3><p>好了，言归正传，<a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 有什么用？它能将输入的图片重新调整为终端窗口字符所能显示范围的大小（比如：80 x 25），然后在任何分辨率的终端窗口用彩色字符显示图像。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005428q9ixpu5if25pnqxp.png" alt="图片.png-37.3kB"></p><p>这幅图用彩色块字符显示了 <a target="_blank" rel="noopener" href="http://design.ubuntu.com/wp-content/uploads/ubuntu-logo112.png">Ubuntu 的 logo</a>，原图是一个 PNG 格式的文件。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005428h6yta595ykwsokz7.png" alt="图片.png-165kB"></p><p>这是 <a target="_blank" rel="noopener" href="https://www.flickr.com/photos/doug88888/5776072628/in/photolist-9WCiNQ-7U3Trc-7YUZBL-5DwkEQ-6e1iT8-a372aS-5F75aL-a1gbow-6eNayj-8gWK2H-5CtH7P-6jVqZv-86RpwN-a2nEnB-aiRmsc-6aKvwK-8hmXrN-5CWDNP-62hWM8-a9smn1-ahQqHw-a22p3w-a36csK-ahN4Pv-7VEmnt-ahMSiT-9NpTa7-5A3Pon-ai7DL7-9TKCqV-ahr7gN-a1boqP-83ZzpH-9Sqjmq-5xujdi-7UmDVb-6J2zQR-5wAGNR-5eERar-5KVDym-5dL8SZ-5S2Uut-7RVyHg-9Z6MAt-aiRiT4-5tLesw-aGLSv6-5ftp6j-5wAVBq-5T2KAP">@Doug8888 拍摄的花</a>。</p><p>如果你通过远程连接服务器来管理自己的业务，并想要查看图像文件，那么 <a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 将会特别有用。</p><p>除了静态图片，<a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 同样也可以显示 gif 动图。</p><p>那么让我们开始 snap 之旅吧！</p><h3 id="熟悉-timg-的源码"><a href="#熟悉-timg-的源码" class="headerlink" title="熟悉 timg 的源码"></a>熟悉 timg 的源码</h3><p><a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 的源码可以在 <a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">https://github.com/hzeller/timg</a> 找到。让我们试着手动编译它，以了解它有什么需求。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005429o3521zzmp9mcc950.png" alt="图片.png-128.4kB"></p><p><code>Makefile</code> 在 <code>src/</code> 子文件夹中而不是项目的根文件夹中。在 github 页面上，他们说需要安装两个开发包（GraphicsMagic++ 和 WebP），然后使用 <code>make</code> 就能生成可执行文件。在截图中可以看到我已经将它们安装好了（在我读完相关的 Readme.md 文件后）。</p><p>因此，在编写 <code>snapcraft.yaml</code> 文件时已经有了四条腹稿：</p><ol><li><code>Makefile</code> 在 <code>src/</code> 子文件夹中而不是项目的根文件夹中。</li><li>这个程序编译时需要两个开发库。</li><li>为了让 timg 以 snap 包形式运行，我们需要将这两个库捆绑在 snap 包中（或者静态链接它们）。</li><li><a target="_blank" rel="noopener" href="https://github.com/hzeller/timg">timg</a> 是用 C++ 编写的，所以需要安装 g++。在编译之前，让我们通过 <code>snapcraft.yaml</code> 文件来检查 <code>build-essential</code> 元包是否已经安装。</li></ol><h3 id="从-snapcraft-开始"><a href="#从-snapcraft-开始" class="headerlink" title="从 snapcraft 开始"></a>从 snapcraft 开始</h3><p>让我们新建一个名为 <code>timg-snap/</code> 的文件夹，并在其中运行 <code>snapcraft init</code> 这条命令来创建 <code>snapcraft.yaml</code> 工作的框架。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~$ mkdir timg-snap</span><br><span class="line">ubuntu@snaps:~$ cd timg-snap/</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft init</span><br><span class="line">Created snap/snapcraft.yaml.</span><br><span class="line">Edit the file to your liking or run `snapcraft` to get started</span><br><span class="line">ubuntu@snaps:~/timg-snap$ cat snap/snapcraft.yaml </span><br><span class="line">name: my-snap-name # you probably want to &#x27;snapcraft register &lt;name&gt;&#x27;</span><br><span class="line">version: &#x27;0.1&#x27; # just for humans, typically &#x27;1.2+git&#x27; or &#x27;1.3.2&#x27;</span><br><span class="line">summary: Single-line elevator pitch for your amazing snap # 79 char long summary</span><br><span class="line">description: |</span><br><span class="line">  This is my-snap&#x27;s description. You have a paragraph or two to tell the most important story about your snap. Keep it under 100 words though, we live in tweetspace and your description wants to look good in the snap store.</span><br><span class="line"></span><br><span class="line">grade: devel # must be &#x27;stable&#x27; to release into candidate/stable channels</span><br><span class="line">confinement: devmode # use &#x27;strict&#x27; once you have the right plugs and slots</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  my-part:</span><br><span class="line">    # See &#x27;snapcraft plugins&#x27;</span><br><span class="line">    plugin: nil</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="填充元数据"><a href="#填充元数据" class="headerlink" title="填充元数据"></a>填充元数据</h3><p><code>snapcraft.yaml</code> 配置文件的上半部分是元数据。我们需要一个一个把它们填满，这算是比较容易的部分。元数据由以下字段组成：</p><ol><li><code>name</code> （名字）—— snap 包的名字，它将公开在 Ubuntu 商店中。</li><li><code>version</code> （版本）—— snap 包的版本号。可以是源代码存储库中一个适当的分支或者标记，如果没有分支或标记的话，也可以是当前日期。</li><li><code>summary</code> （摘要）—— 不超过 80 个字符的简短描述。</li><li><code>description</code> （描述）—— 长一点的描述, 100 个字以下。</li><li><code>grade</code> （等级）—— <code>stable</code> （稳定）或者 <code>devel</code> （开发）。因为我们想要在 Ubuntu 商店的稳定通道中发布这个 snap 包，所以在 snap 包能正常工作后，就把它设置成 <code>stable</code>。</li><li><code>confinement</code> （限制）—— 我们首先设置为 <code>devmode</code> （开发模式），这样系统将不会以任何方式限制 snap 包。一旦它在 <code>devmode</code>下能正常工作，我们再考虑选择 <code>strict</code> （严格）还是 <code>classic</code> （传统）限制。</li></ol><p>我们将使用 <code>timg</code> 这个名字：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft register timg</span><br><span class="line">Registering timg.</span><br><span class="line">You already own the name &#x27;timg&#x27;.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>是的，这个名字我已经注册了 :-)。</p><p>接下来，我们应该选择哪个版本的 timg？</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005429bf4787aa48787899.png" alt="图片.png-72.7kB"></p><p>当在仓库中寻找分支或标记时，我们会发现有一个 v0.9.5 标签，其中有 2016 年 6 月 27 日最新提交的代码。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005429isi8z381pkdsf1gs.png" alt="图片.png-71.4kB"></p><p>然而主分支（<code>master</code>）中有两个看起来很重要的提交。因此我们使用主分支而不用 <code>v0.9.5</code> 标签的那个。我们使用今天的日期—— <code>20170226</code> 做为版本号。</p><p>我们从仓库中搜集了摘要和描述。其中摘要的内容为 <code>A terminal image viewer</code>，描述的内容为 <code>A viewer that uses 24-Bit color capabilities and unicode character blocks to display images in the terminal</code>。</p><p>最后，将 <code>grade</code> （等级）设置为 <code>stable</code> （稳定），将 <code>confinement</code> 限制设置为 <code>devmode</code> （开发模式）（一直到 snap 包真正起作用）。</p><p>这是更新后的 <code>snapcraft.yaml</code>，带有所有的元数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ cat snap/snapcraft.yaml </span><br><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: devmode</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  my-part:</span><br><span class="line">    # See &#x27;snapcraft plugins&#x27;</span><br><span class="line">    plugin: nil</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="弄清楚-parts-是什么"><a href="#弄清楚-parts-是什么" class="headerlink" title="弄清楚 parts: 是什么"></a>弄清楚 <code>parts:</code> 是什么</h3><p>现在我们需要将上面已经存在的 <code>parts:</code> 部分替换成真实的 <code>parts:</code>。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005430rbpub2wbkpkqwksp.png" alt="timg-git-url.png-8kB"></p><p><em>Git 仓库的 URL。</em></p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005430j25sdioid56xz9kp.png" alt="图片.png-28.7kB"></p><p><em>存在 Makefile，因此我们需要 make 插件。</em></p><p>我们已经知道 git 仓库的 URL 链接，并且 timg 源码中已有了 <code>Makefile</code> 文件。至于 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/make">snapcraft make 插件</a> 的 Makefile 命令，正如文档所言，这个插件总是会运行 <code>make</code> 后再运行 <code>make install</code>。为了确认 <code>make</code> 插件的用法，我查看了 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/">snapcraft 可用插件列表</a>。</p><p>因此，我们将最初的配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  my-part:</span><br><span class="line">    # See &#x27;snapcraft plugins&#x27;</span><br><span class="line">    plugin: nil</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    plugin: make</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是当前 <code>snapcraft.yaml</code> 文件的内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks </span><br><span class="line">  to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: devmode</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    plugin: make</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>让我们运行下 <code>snapcraft prime</code> 命令看看会发生什么：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime</span><br><span class="line">Preparing to pull timg </span><br><span class="line">Pulling timg </span><br><span class="line">Cloning into &#x27;/home/ubuntu/timg-snap/parts/timg/src&#x27;...</span><br><span class="line">remote: Counting objects: 144, done.</span><br><span class="line">remote: Total 144 (delta 0), reused 0 (delta 0), pack-reused 144</span><br><span class="line">Receiving objects: 100% (144/144), 116.00 KiB | 0 bytes/s, done.</span><br><span class="line">Resolving deltas: 100% (89/89), done.</span><br><span class="line">Checking connectivity... done.</span><br><span class="line">Preparing to build timg </span><br><span class="line">Building timg </span><br><span class="line">make -j4</span><br><span class="line">make: *** No targets specified and no makefile found.  Stop.</span><br><span class="line">Command &#x27;[&#x27;/bin/sh&#x27;, &#x27;/tmp/tmpem97fh9d&#x27;, &#x27;make&#x27;, &#x27;-j4&#x27;]&#x27; returned non-zero exit status 2</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以看到 <code>snapcraft</code> 无法在源代码中找到 <code>Makefile</code> 文件，正如我们之前所暗示的，<code>Makefile</code> 位于 <code>src/</code> 子文件夹中。那么，我们可以让 <code>snapcraft</code> 使用 <code>src/</code> 文件夹中的 <code>Makefile</code> 文件吗？</p><p>每个 snapcraft 插件都有自己的选项，并且有一些通用选项是所有插件共享的。在本例中，我们希望研究那些<a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/source">与源代码相关的 snapcraft 选项</a>。我们开始吧：</p><p><strong>source-subdir：path</strong></p><p>snapcraft 会<ruby>检出 <rt>checkout</rt></ruby> <code>source</code> 关键字所引用的仓库或者解压归档文件到 <code>parts/&lt;part-name&gt;/src/</code> 中，但是它只会将特定的子目录复制到 <code>parts/&lt;part-name&gt;/build/</code> 中。</p><p>我们已经有了适当的选项，下面更新下 <code>parts</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后再次运行 <code>snapcraft prime</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime </span><br><span class="line">The &#x27;pull&#x27; step of &#x27;timg&#x27; is out of date:</span><br><span class="line"></span><br><span class="line">The &#x27;source-subdir&#x27; part property appears to have changed.</span><br><span class="line"></span><br><span class="line">Please clean that part&#x27;s &#x27;pull&#x27; step in order to continue</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft clean</span><br><span class="line">Cleaning up priming area</span><br><span class="line">Cleaning up staging area</span><br><span class="line">Cleaning up parts directory</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime </span><br><span class="line">Skipping pull timg (already ran)</span><br><span class="line">Preparing to build timg </span><br><span class="line">Building timg </span><br><span class="line">make -j4</span><br><span class="line">g++ `GraphicsMagick++-config --cppflags --cxxflags` -Wall -O3 -fPIC -c -o timg.o timg.cc</span><br><span class="line">g++ -Wall -O3 -fPIC   -c -o terminal-canvas.o terminal-canvas.cc</span><br><span class="line">/bin/sh: 1: GraphicsMagick++-config: not found</span><br><span class="line">timg.cc:33:22: fatal error: Magick++.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">Makefile:10: recipe for target &#x27;timg.o&#x27; failed</span><br><span class="line">make: *** [timg.o] Error 1</span><br><span class="line">make: *** Waiting for unfinished jobs....</span><br><span class="line">Command &#x27;[&#x27;/bin/sh&#x27;, &#x27;/tmp/tmpeeyxj5kw&#x27;, &#x27;make&#x27;, &#x27;-j4&#x27;]&#x27; returned non-zero exit status 2</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从错误信息我们可以得知 snapcraft 找不到 GraphicsMagick++ 这个开发库文件。根据 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/common">snapcraft 常见关键字</a> 可知，我们需要在 <code>snapcraft.yaml</code> 中指定这个库文件，这样 snapcraft 才能安装它。</p><p><strong>build-packages：[deb, deb, deb…]</strong></p><p>列出构建 part 前需要在主机中安装的 Ubuntu 包。这些包通常不会进入最终的 snap 包中，除非它们含有 snap 包中二进制文件直接依赖的库文件（在这种情况下，可以通过 <code>ldd</code> 发现它们），或者在 <code>stage-package</code> 中显式地指定了它们。</p><p>让我们寻找下这个开发包的名字：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ apt-cache search graphicsmagick++ | grep dev</span><br><span class="line">graphicsmagick-libmagick-dev-compat/xenial 1.3.23-1build1 all</span><br><span class="line">libgraphicsmagick++1-dev/xenial 1.3.23-1build1 amd64</span><br><span class="line">  format-independent image processing - C++ development files</span><br><span class="line">libgraphicsmagick1-dev/xenial 1.3.23-1build1 amd64</span><br><span class="line">  format-independent image processing - C development files</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看到包名为 <code>libgraphicsmagick++1-dev</code>，下面是更新后的 <code>parts</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再次运行 <code>snapcraft</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft</span><br><span class="line">Installing build dependencies: libgraphicsmagick++1-dev</span><br><span class="line">[...]</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libgraphicsmagick++-q16-12 libgraphicsmagick++1-dev libgraphicsmagick-q16-3</span><br><span class="line">  libgraphicsmagick1-dev libwebp5</span><br><span class="line">[...]</span><br><span class="line">Building timg </span><br><span class="line">make -j4</span><br><span class="line">g++ `GraphicsMagick++-config --cppflags --cxxflags` -Wall -O3 -fPIC -c -o timg.o timg.cc</span><br><span class="line">g++ -Wall -O3 -fPIC   -c -o terminal-canvas.o terminal-canvas.cc</span><br><span class="line">g++ -o timg timg.o terminal-canvas.o `GraphicsMagick++-config --ldflags --libs`</span><br><span class="line">/usr/bin/ld: cannot find -lwebp</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">Makefile:7: recipe for target &#x27;timg&#x27; failed</span><br><span class="line">make: *** [timg] Error 1</span><br><span class="line">Command &#x27;[&#x27;/bin/sh&#x27;, &#x27;/tmp/tmptma45jzl&#x27;, &#x27;make&#x27;, &#x27;-j4&#x27;]&#x27; returned non-zero exit status 2</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>虽然只指定了开发库 <code>libgraphicsmagick+1-dev</code>，但 Ubuntu 还安装了一些代码库，包括 <code>libgraphicsmagick ++-q16-12</code>，以及动态代码库 <code>libwebp</code>。</p><p>这里仍然有一个错误，这个是因为缺少开发版本的 <code>webp</code> 库（一个静态库）。我们可以通过下面的命令找到它：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ apt-cache search libwebp | grep dev</span><br><span class="line">libwebp-dev - Lossy compression of digital photographic images.</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面安装的 <code>libwebp5</code> 包只提供了一个动态库（.so）。通过 <code>libwebp-dev</code> 包，我们可以得到相应的静态库（.a）。好了，让我们更新下 <code>parts:</code> 部分：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages:</span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>下面是更新后的 <code>snapcraft.yaml</code> 文件的内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks </span><br><span class="line">  to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: devmode</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>让我们运行下 <code>snapcraft prime</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime</span><br><span class="line">Skipping pull timg (already ran)</span><br><span class="line">Preparing to build timg </span><br><span class="line">Building timg </span><br><span class="line">make -j4</span><br><span class="line">g++ `GraphicsMagick++-config --cppflags --cxxflags` -Wall -O3 -fPIC -c -o timg.o timg.cc</span><br><span class="line">g++ -Wall -O3 -fPIC   -c -o terminal-canvas.o terminal-canvas.cc</span><br><span class="line">g++ -o timg timg.o terminal-canvas.o `GraphicsMagick++-config --ldflags --libs`</span><br><span class="line">make install DESTDIR=/home/ubuntu/timg-snap/parts/timg/install</span><br><span class="line">install timg /usr/local/bin</span><br><span class="line">install: cannot create regular file &#x27;/usr/local/bin/timg&#x27;: Permission denied</span><br><span class="line">Makefile:13: recipe for target &#x27;install&#x27; failed</span><br><span class="line">make: *** [install] Error 1</span><br><span class="line">Command &#x27;[&#x27;/bin/sh&#x27;, &#x27;/tmp/tmptq_s1itc&#x27;, &#x27;make&#x27;, &#x27;install&#x27;, &#x27;DESTDIR=/home/ubuntu/timg-snap/parts/timg/install&#x27;]&#x27; returned non-zero exit status 2</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们遇到了一个新问题。由于 <code>Makefile</code> 文件是手工编写的，不符合 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/make">snapcraft make 插件</a> 的参数设置，所以不能正确安装到 <code>prime/</code> 文件夹中。<code>Makefile</code> 会尝试安装到 <code>usr/local/bin</code> 中。</p><p>我们需要告诉 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/reference/plugins/make">snapcraft make 插件</a> 不要运行 <code>make install</code>，而是找到 <code>timg</code> 可执行文件然后把它放到 <code>prime/</code> 文件夹中。根据文档的描述：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- artifacts:</span><br><span class="line">（列表）</span><br><span class="line">将 make 生成的指定文件复制或者链接到 snap 包安装目录。如果使用，则 `make install` 这步操作将被忽略。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所以，我们需要将一些东西放到 <code>artifacts:</code> 中。但是具体是哪些东西？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap/parts/timg$ ls build/src/</span><br><span class="line">Makefile            terminal-canvas.h  timg*     timg.o</span><br><span class="line">terminal-canvas.cc  terminal-canvas.o  timg.cc</span><br><span class="line">ubuntu@snaps:~/timg-snap/parts/timg$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 <code>build/</code> 子目录中，我们可以找到 <code>make</code> 的输出结果。由于我们设置了 <code>source-subdir:</code> 为 <code>src</code>，所以 <code>artifacts:</code> 的基目录为 <code>build/src</code>。在这里我们可以找到可执行文件 <code>timg</code>，我们需要将它设置为 <code>artifacts:</code> 的一个参数。通过 <code>artifacts:</code>，我们可以把 <code>make</code> 输出的某些文件复制到 snap 包的安装目录（在 <code>prime/</code> 中）。</p><p>下面是更新后 <code>snapcraft.yaml</code> 文件 <code>parts:</code> 部分的内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line">    artifacts: [timg]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>让我们运行 <code>snapcraft prime</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime</span><br><span class="line">Preparing to pull timg </span><br><span class="line">Pulling timg </span><br><span class="line">Cloning into &#x27;/home/ubuntu/timg-snap/parts/timg/src&#x27;...</span><br><span class="line">remote: Counting objects: 144, done.</span><br><span class="line">remote: Total 144 (delta 0), reused 0 (delta 0), pack-reused 144</span><br><span class="line">Receiving objects: 100% (144/144), 116.00 KiB | 207.00 KiB/s, done.</span><br><span class="line">Resolving deltas: 100% (89/89), done.</span><br><span class="line">Checking connectivity... done.</span><br><span class="line">Preparing to build timg </span><br><span class="line">Building timg </span><br><span class="line">make -j4</span><br><span class="line">g++ `GraphicsMagick++-config --cppflags --cxxflags` -Wall -O3 -fPIC -c -o timg.o timg.cc</span><br><span class="line">g++ -Wall -O3 -fPIC   -c -o terminal-canvas.o terminal-canvas.cc</span><br><span class="line">g++ -o timg timg.o terminal-canvas.o `GraphicsMagick++-config --ldflags --libs`</span><br><span class="line">Staging timg </span><br><span class="line">Priming timg </span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们还将继续迭代。</p><h3 id="导出命令"><a href="#导出命令" class="headerlink" title="导出命令"></a>导出命令</h3><p>到目前为止，snapcraft 生成了可执行文件，但没有导出给用户使用的命令。接下来我们需要通过 <code>apps:</code> 导出一个命令。</p><p>首先我们需要知道命令在 <code>prime/</code> 的哪个子文件夹中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ ls prime/</span><br><span class="line">meta/  snap/  timg*  usr/</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>它在 <code>prime/</code> 子文件夹的根目录中。现在，我们已经准备好要在 <code>snapcaft.yaml</code> 中增加 <code>apps:</code> 的内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ cat snap/snapcraft.yaml </span><br><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks </span><br><span class="line">  to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: devmode</span><br><span class="line"></span><br><span class="line">apps:</span><br><span class="line">  timg: </span><br><span class="line">    command: timg</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line">    artifacts: [timg]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>让我们再次运行 <code>snapcraft prime</code>，然后测试下生成的 snap 包：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft prime </span><br><span class="line">Skipping pull timg (already ran)</span><br><span class="line">Skipping build timg (already ran)</span><br><span class="line">Skipping stage timg (already ran)</span><br><span class="line">Skipping prime timg (already ran)</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snap try --devmode prime/</span><br><span class="line">timg 20170226 mounted from /home/ubuntu/timg-snap/prime</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005430z79wgjktgadlv7lk.png" alt="图片.png-42.3kB"></p><p><em>图片来源： <a target="_blank" rel="noopener" href="https://www.flickr.com/photos/mustangjoe/6091603784/">https://www.flickr.com/photos/mustangjoe/6091603784/</a></em></p><p>我们可以通过 <code>snap try --devmode prime/</code> 启用该 snap 包然后测试 <code>timg</code> 命令。这是一种高效的测试方法，可以避免生成 .snap 文件，并且无需安装和卸载它们，因为 <code>snap try prime/</code> 直接使用了 <code>prime/</code> 文件夹中的内容。</p><h3 id="限制-snap"><a href="#限制-snap" class="headerlink" title="限制 snap"></a>限制 snap</h3><p>到目前为止，snap 包一直是在不受限制的开发模式下运行的。让我们看看如何限制它的运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snap list</span><br><span class="line">Name           Version   Rev   Developer  Notes</span><br><span class="line">core           16-2      1337  canonical  -</span><br><span class="line">timg           20170226  x1               devmode,try</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snap try --jailmode prime</span><br><span class="line">timg 20170226 mounted from /home/ubuntu/timg-snap/prime</span><br><span class="line">ubuntu@snaps:~/timg-snap$ snap list</span><br><span class="line">Name           Version   Rev   Developer  Notes</span><br><span class="line">core           16-2      1337  canonical  -</span><br><span class="line">timg           20170226  x2               jailmode,try</span><br><span class="line">ubuntu@snaps:~/timg-snap$ timg pexels-photo-149813.jpeg </span><br><span class="line">Trouble loading pexels-photo-149813.jpeg (Magick: Unable to open file (pexels-photo-149813.jpeg) reported by magick/blob.c:2828 (OpenBlob))</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过这种方式，我们可以无需修改 <code>snapcraft.yaml</code> 文件就从开发模式（<code>devmode</code>）切换到限制模式（<code>jailmode</code>）（<code>confinement: strict</code>）。正如预期的那样，<code>timg</code> 无法读取图像，因为我们没有开放访问文件系统的权限。</p><p>现在，我们需要作出决定。使用限制模式，我们可以很容易授予某个命令访问用户 <code>$HOME</code> 目录中文件的权限，但是只能访问那里。如果图像文件位于其它地方，我们总是需要复制到 <code>$HOME</code> 目录并在 <code>$HOME</code> 的副本上运行 timg。如果我们觉得可行，那我们可以设置 <code>snapcraf.yaml</code> 为:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks </span><br><span class="line">  to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: strict</span><br><span class="line"></span><br><span class="line">apps:</span><br><span class="line">  timg: </span><br><span class="line">    command: timg</span><br><span class="line">    plugs: [home]</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line">    artifacts: [timg]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>另一方面，如果希望 timg snap 包能访问整个文件系统，我们可以设置传统限制来实现。对应的 <code>snapcraft.yaml</code> 内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">name: timg</span><br><span class="line">version: &#x27;20170226&#x27;</span><br><span class="line">summary: A terminal image viewer</span><br><span class="line">description: |</span><br><span class="line">  A viewer that uses 24-Bit color capabilities and unicode character blocks </span><br><span class="line">  to display images in the terminal.</span><br><span class="line"></span><br><span class="line">grade: stable </span><br><span class="line">confinement: classic</span><br><span class="line"></span><br><span class="line">apps:</span><br><span class="line">  timg: </span><br><span class="line">    command: timg</span><br><span class="line"></span><br><span class="line">parts:</span><br><span class="line">  timg:</span><br><span class="line">    source: https://github.com/hzeller/timg.git</span><br><span class="line">    source-subdir: src</span><br><span class="line">    plugin: make</span><br><span class="line">    build-packages: </span><br><span class="line">      - libgraphicsmagick++1-dev</span><br><span class="line">      - libwebp-dev</span><br><span class="line">    artifacts: [timg]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来我们将选择严格（<code>strict</code>）约束选项。因此，图像应该只能放在 $HOME 中。</p><h3 id="打包和测试"><a href="#打包和测试" class="headerlink" title="打包和测试"></a>打包和测试</h3><p>让我们打包这个 snap，也就是制作 .snap 文件，然后在新安装的 Ubuntu 系统上对它进行测试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaps:~/timg-snap$ snapcraft </span><br><span class="line">Skipping pull timg (already ran)</span><br><span class="line">Skipping build timg (already ran)</span><br><span class="line">Skipping stage timg (already ran)</span><br><span class="line">Skipping prime timg (already ran)</span><br><span class="line">Snapping &#x27;timg&#x27; \                                                 </span><br><span class="line">Snapped timg_20170226_amd64.snap</span><br><span class="line">ubuntu@snaps:~/timg-snap$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们如何在几秒钟内得到一个全新安装的 Ubuntu 系统来对 snap 包进行测试？</p><p>请查看 <a target="_blank" rel="noopener" href="https://blog.simos.info/trying-out-lxd-containers-on-our-ubuntu/">尝试在 Ubuntu 上使用 LXD 容器</a>，并在你的系统上设置 LXD。然后回到这里，尝试运行下面的命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ lxc launch ubuntu:x snaptesting</span><br><span class="line">Creating snaptesting</span><br><span class="line">Starting snaptesting</span><br><span class="line">$ lxc file push timg_20170226_amd64.snap snaptesting/home/ubuntu/</span><br><span class="line">$ lxc exec snaptesting -- sudo su - ubuntu</span><br><span class="line">To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.</span><br><span class="line">See &quot;man sudo_root&quot; for details.</span><br><span class="line"></span><br><span class="line">ubuntu@snaptesting:~$ ls</span><br><span class="line">timg_20170226_amd64.snap</span><br><span class="line">ubuntu@snaptesting:~$ snap install timg_20170226_amd64.snap </span><br><span class="line">error: access denied (try with sudo)</span><br><span class="line">ubuntu@snaptesting:~$ sudo snap install timg_20170226_amd64.snap</span><br><span class="line">error: cannot find signatures with metadata for snap &quot;timg_20170226_amd64.snap&quot;</span><br><span class="line">ubuntu@snaptesting:~$ sudo snap install timg_20170226_amd64.snap --dangerous</span><br><span class="line">error: cannot perform the following tasks:</span><br><span class="line">- Mount snap &quot;core&quot; (1337) ([start snap-core-1337.mount] failed with exit status 1: Job for snap-core-1337.mount failed. See &quot;systemctl status snap-core-1337.mount&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line">)</span><br><span class="line">ubuntu@snaptesting:~$ sudo apt install squashfuse</span><br><span class="line">[...]</span><br><span class="line">Setting up squashfuse (0.1.100-0ubuntu1~ubuntu16.04.1) ...</span><br><span class="line">ubuntu@snaptesting:~$ sudo snap install timg_20170226_amd64.snap --dangerous</span><br><span class="line">timg 20170226 installed</span><br><span class="line">ubuntu@snaptesting:~$ wget https://farm7.staticflickr.com/6187/6091603784_d6960c8be2_z_d.jpg</span><br><span class="line">[...]</span><br><span class="line">2017-02-26 22:12:18 (636 KB/s) - ‘6091603784_d6960c8be2_z_d.jpg’ saved [240886/240886]</span><br><span class="line">ubuntu@snaptesting:~$ timg 6091603784_d6960c8be2_z_d.jpg </span><br><span class="line">[it worked!]</span><br><span class="line">ubuntu@snaptesting:~$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们启动了一个名为 <code>snaptesting</code> 的 LXD 容器，并将 .snap 文件复制进去。然后，通过普通用户连接到容器，并尝试安装 snap 包。最初，我们安装失败了，因为在无特权的 LXD 容器中安装 snap 包需要使用 <code>sudo</code> 。接着又失败了，因为 .snap 没有经过签名（我们需要使用 <code>--dangerous</code> 参数）。然而还是失败了，这次是因为我们需要安装 <code>squashfuse</code> 包（Ubuntu 16.04 镜像中没有预装）。最后，我们成功安装了snap，并设法查看了图像。</p><p>在一个全新安装的 Linux 系统中测试 snap 包是很重要的，因为这样才能确保 snap 包中包含所有必须的代码库。在这个例子中，我们使用了静态库并运行良好。</p><h3 id="发布到-Ubuntu-商店"><a href="#发布到-Ubuntu-商店" class="headerlink" title="发布到 Ubuntu 商店"></a>发布到 Ubuntu 商店</h3><p>这是 <a target="_blank" rel="noopener" href="https://snapcraft.io/docs/build-snaps/publish">发布 snap 包到 Ubuntu 商店的说明</a>。 在之前的教程中，我们已经发布了一些 snap 包。对于 <code>timg</code> 来说，我们设置了严格限制和稳定等级。因此，我们会将它发布到稳定通道。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ snapcraft push timg_20170226_amd64.snap </span><br><span class="line">Pushing &#x27;timg_20170226_amd64.snap&#x27; to the store.</span><br><span class="line">Uploading timg_20170226_amd64.snap [                                       ]   0%</span><br><span class="line">Uploading timg_20170226_amd64.snap [=======================================] 100%</span><br><span class="line">Ready to release!|                                                               </span><br><span class="line">Revision 6 of &#x27;timg&#x27; created.</span><br><span class="line">$ snapcraft release timg 6 stable</span><br><span class="line">Track    Arch    Series    Channel    Version    Revision</span><br><span class="line">latest   amd64   16        stable     20170226   6</span><br><span class="line">                           candidate  ^          ^</span><br><span class="line">                           beta       0.9.5      5</span><br><span class="line">                           edge       0.9.5      5</span><br><span class="line">The &#x27;stable&#x27; channel is now open.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们把 .snap 包推送到 Ubuntu 商店后，得到了一个 <code>Revision 6</code>。然后，我们将 timg <code>Revision 6</code> 发布到了 Ubuntu 商店的稳定通道。</p><p>在候选通道中没有已发布的 snap 包，它继承的是稳定通道的包，所以显示 <code>^</code> 字符。</p><p>在之前的测试中，我将一些较老版本的 snap 包上传到了测试和边缘通道。这些旧版本使用了 timg 标签为 <code>0.9.5</code> 的源代码。</p><p>我们可以通过将稳定版本发布到测试和边缘通道来移除旧的 0.9.5 版本的包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ snapcraft release timg 6 beta</span><br><span class="line">Track    Arch    Series    Channel    Version    Revision</span><br><span class="line">latest   amd64   16        stable     20170226   6</span><br><span class="line">                           candidate  ^          ^</span><br><span class="line">                           beta       20170226   6</span><br><span class="line">                           edge       0.9.5      5</span><br><span class="line">$ snapcraft release timg 6 edge</span><br><span class="line">Track    Arch    Series    Channel    Version    Revision</span><br><span class="line">latest   amd64   16        stable     20170226   6</span><br><span class="line">                           candidate  ^          ^</span><br><span class="line">                           beta       20170226   6</span><br><span class="line">                           edge       20170226   6</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="使用-timg"><a href="#使用-timg" class="headerlink" title="使用 timg"></a>使用 timg</h3><p>让我们不带参数运行 <code>timg</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@snaptesting:~$ timg</span><br><span class="line">Expected image filename.</span><br><span class="line">usage: /snap/timg/x1/timg [options] &lt;image&gt; [&lt;image&gt;...]</span><br><span class="line">Options:</span><br><span class="line">    -g&lt;w&gt;x&lt;h&gt;  : Output pixel geometry. Default from terminal 80x48</span><br><span class="line">    -s[&lt;ms&gt;]   : Scroll horizontally (optionally: delay ms (60)).</span><br><span class="line">    -d&lt;dx:dy&gt;  : delta x and delta y when scrolling (default: 1:0).</span><br><span class="line">    -w&lt;seconds&gt;: If multiple images given: Wait time between (default: 0.0).</span><br><span class="line">    -t&lt;seconds&gt;: Only animation or scrolling: stop after this time.</span><br><span class="line">    -c&lt;num&gt;    : Only Animation or scrolling: number of runs through a full cycle.</span><br><span class="line">    -C         : Clear screen before showing image.</span><br><span class="line">    -F         : Print filename before showing picture.</span><br><span class="line">    -v         : Print version and exit.</span><br><span class="line">If both -c and -t are given, whatever comes first stops.</span><br><span class="line">If both -w and -t are given for some animation/scroll, -t takes precedence</span><br><span class="line">ubuntu@snaptesting:~$</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里提到当前我们终端模拟器的缩放级别，即分辨率为：80 × 48。</p><p>让我们缩小一点，并最大化 GNOME 终端窗口。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-g&lt;w&gt;x&lt;h&gt;  : Output pixel geometry. Default from terminal 635x428</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是一个更好的解决方案，但我几乎看不到字符，因为他们太小了。让我们调用前面的命令再次显示这辆车。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/04/005431hpzmiudusl3iffse.png" alt="图片.png-904.9kB"></p><p>你所看到的是调整后的图像（1080p）。虽然它是用彩色文本字符显示的，但看起来依旧很棒。</p><p>接下来呢？<code>timg</code> 其实也可以播放 gif 动画哦！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://m.popkey.co/9b7141/QbAV_f-maxage-0.gif -O JonahHillAmazed.gif$ timg JonahHillAmazed.gif</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你可以试着安装 <code>timg</code> 来体验 gif 动画。要是不想自己动手，可以在 <a target="_blank" rel="noopener" href="https://asciinema.org/a/dezbe2gpye84e0pjndp8t0pvh">asciinema</a> 上查看相关记录 （如果视频看上去起伏不定的，请重新运行它）。</p><p>谢谢阅读！</p><hr><p>译者简介：</p><p>经常混迹于 snapcraft.io，对 Ubuntu Core、Snaps 和 Snapcraft 有着浓厚的兴趣，并致力于将这些还在快速发展的新技术通过翻译或原创的方式介绍到中文世界。有兴趣的小伙伴也可以关注译者个人公众号： <code>Snapcraft</code></p><hr><p>via：<a target="_blank" rel="noopener" href="https://blog.simos.info/how-to-create-a-snap-for-timg-with-snapcraft-on-ubuntu/">https://blog.simos.info/how-to-create-a-snap-for-timg-with-snapcraft-on-ubuntu/</a></p><p>作者：<a target="_blank" rel="noopener" href="https://blog.simos.info/">Mi blog lah!</a> 译者：<a target="_blank" rel="noopener" href="https://github.com/Snapcrafter">Snapcrafter</a> 校对：<a target="_blank" rel="noopener" href="https://github.com/wxy">wxy</a></p><p>本文由 <a target="_blank" rel="noopener" href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a target="_blank" rel="noopener" href="https://linux.cn/">Linux中国</a> 荣誉推出</p></div></div></div><div class="footer"><p class="footer-copyright"><span>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></span> <span>Theme <a target="_blank" href="https://github.com/tinkink-co/hexo-theme-terminal">Terminal</a></span><script type="text/javascript" src="https://cdn.staticfile.net/jquery/3.4.1/jquery.min.js"></script><script>getCDNinfo=function(){$.ajax({url:"/cdn-cgi/trace",success:function(a,n){let i="Antananarivo, Madagascar - (TNR);Cape Town, South Africa - (CPT);Casablanca, Morocco - (CMN);Dar Es Salaam, Tanzania - (DAR);Djibouti City, Djibouti - (JIB);Durban, South Africa - (DUR);Johannesburg, South Africa - (JNB);Kigali, Rwanda - (KGL);Lagos, Nigeria - (LOS);Luanda, Angola - (LAD);Maputo, MZ - (MPM);Mombasa, Kenya - (MBA);Port Louis, Mauritius - (MRU);Réunion, France - (RUN);Bangalore, India - (BLR);Bangkok, Thailand - (BKK);Bandar Seri Begawan, Brunei - (BWN);Cebu, Philippines - (CEB);Chengdu, China - (CTU);Chennai, India - (MAA);Chittagong, Bangladesh - (CGP);Chongqing, China - (CKG);Colombo, Sri Lanka - (CMB);Dhaka, Bangladesh - (DAC);Dongguan, China - (SZX);Foshan, China - (FUO);Fuzhou, China - (FOC);Guangzhou, China - (CAN);Hangzhou, China - (HGH);Hanoi, Vietnam - (HAN);Hengyang, China - (HNY);Ho Chi Minh City, Vietnam - (SGN);Hong Kong - (HKG);Hyderabad, India - (HYD);Islamabad, Pakistan - (ISB);Jakarta, Indonesia - (CGK);Jinan, China - (TNA);Karachi, Pakistan - (KHI);Kathmandu, Nepal - (KTM);Kolkata, India - (CCU);Kuala Lumpur, Malaysia - (KUL);Lahore, Pakistan - (LHE);Langfang, China - (NAY);Luoyang, China - (LYA);Macau - (MFM);Malé, Maldives - (MLE);Manila, Philippines - (MNL);Mumbai, India - (BOM);Nagpur, India - (NAG);Nanning, China - (NNG);New Delhi, India - (DEL);Osaka, Japan - (KIX);Phnom Penh, Cambodia - (PNH);Qingdao, China - (TAO);Seoul, South Korea - (ICN);Shanghai, China - (SHA);Shenyang, China - (SHE);Shijiazhuang, China - (SJW);Singapore, Singapore - (SIN);Suzhou, China - (SZV);Taipei - (TPE);Thimphu, Bhutan - (PBH);Tianjin, China - (TSN);Tokyo, Japan - (NRT);Ulaanbaatar, Mongolia - (ULN);Vientiane, Laos - (VTE);Wuhan, China - (WUH);Wuxi, China - (WUX);Xi'an, China - (XIY);Yerevan, Armenia - (EVN);Zhengzhou, China - (CGO);Zuzhou, China - (CSX);Amsterdam, Netherlands - (AMS);Athens, Greece - (ATH);Barcelona, Spain - (BCN);Belgrade, Serbia - (BEG);Berlin, Germany - (TXL);Brussels, Belgium - (BRU);Bucharest, Romania - (OTP);Budapest, Hungary - (BUD);Chișinău, Moldova - (KIV);Copenhagen, Denmark - (CPH);Cork, Ireland -  (ORK);Dublin, Ireland - (DUB);Düsseldorf, Germany - (DUS);Edinburgh, United Kingdom - (EDI);Frankfurt, Germany - (FRA);Geneva, Switzerland - (GVA);Gothenburg, Sweden - (GOT);Hamburg, Germany - (HAM);Helsinki, Finland - (HEL);Istanbul, Turkey - (IST);Kyiv, Ukraine - (KBP);Lisbon, Portugal - (LIS);London, United Kingdom - (LHR);Luxembourg City, Luxembourg - (LUX);Madrid, Spain - (MAD);Manchester, United Kingdom - (MAN);Marseille, France - (MRS);Milan, Italy - (MXP);Moscow, Russia - (DME);Munich, Germany - (MUC);Nicosia, Cyprus - (LCA);Oslo, Norway - (OSL);Paris, France - (CDG);Prague, Czech Republic - (PRG);Reykjavík, Iceland - (KEF);Riga, Latvia - (RIX);Rome, Italy - (FCO);Saint Petersburg, Russia - (LED);Sofia, Bulgaria - (SOF);Stockholm, Sweden - (ARN);Tallinn, Estonia - (TLL);Thessaloniki, Greece - (SKG);Vienna, Austria - (VIE);Vilnius, Lithuania - (VNO);Warsaw, Poland - (WAW);Zagreb, Croatia - (ZAG);Zürich, Switzerland - (ZRH);Arica, Chile - (ARI);Asunción, Paraguay - (ASU);Bogotá, Colombia - (BOG);Buenos Aires, Argentina - (EZE);Curitiba, Brazil - (CWB);Fortaleza, Brazil - (FOR);Guatemala City, Guatemala - (GUA);Lima, Peru - (LIM);Medellín, Colombia - (MDE);Panama City, Panama - (PTY);Porto Alegre, Brazil - (POA);Quito, Ecuador - (UIO);Rio de Janeiro, Brazil - (GIG);São Paulo, Brazil - (GRU);Santiago, Chile - (SCL);Willemstad, Curaçao - (CUR);St. George's, Grenada - (GND);Amman, Jordan - (AMM);Baghdad, Iraq - (BGW);Baku, Azerbaijan - (GYD);Beirut, Lebanon - (BEY);Doha, Qatar - (DOH);Dubai, United Arab Emirates - (DXB);Kuwait City, Kuwait - (KWI);Manama, Bahrain - (BAH);Muscat, Oman - (MCT);Ramallah - (ZDM);Riyadh, Saudi Arabia - (RUH);Tel Aviv, Israel - (TLV);Ashburn, VA, United States - (IAD);Atlanta, GA, United States - (ATL);Boston, MA, United States - (BOS);Buffalo, NY, United States - (BUF);Calgary, AB, Canada - (YYC);Charlotte, NC, United States - (CLT);Chicago, IL, United States - (ORD);Columbus, OH, United States - (CMH);Dallas, TX, United States - (DFW);Denver, CO, United States - (DEN);Detroit, MI, United States - (DTW);Honolulu, HI, United States - (HNL);Houston, TX, United States - (IAH);Indianapolis, IN, United States - (IND);Jacksonville, FL, United States - (JAX);Kansas City, MO, United States - (MCI);Las Vegas, NV, United States - (LAS);Los Angeles, CA, United States - (LAX);McAllen, TX, United States - (MFE);Memphis, TN, United States - (MEM);Mexico City, Mexico - (MEX);Miami, FL, United States - (MIA);Minneapolis, MN, United States - (MSP);Montgomery, AL, United States - (MGM);Montréal, QC, Canada - (YUL);Nashville, TN, United States - (BNA);Newark, NJ, United States - (EWR);Norfolk, VA, United States - (ORF);Omaha, NE, United States - (OMA);Philadelphia, United States - (PHL);Phoenix, AZ, United States - (PHX);Pittsburgh, PA, United States - (PIT);Port-Au-Prince, Haiti - (PAP);Portland, OR, United States - (PDX);Queretaro, MX, Mexico - (QRO);Richmond, Virginia - (RIC);Sacramento, CA, United States - (SMF);Salt Lake City, UT, United States - (SLC);San Diego, CA, United States - (SAN);San Jose, CA, United States - (SJC);Saskatoon, SK, Canada - (YXE);Seattle, WA, United States - (SEA);St. Louis, MO, United States - (STL);Tampa, FL, United States - (TPA);Toronto, ON, Canada - (YYZ);Vancouver, BC, Canada - (YVR);Tallahassee, FL, United States - (TLH);Winnipeg, MB, Canada - (YWG);Adelaide, SA, Australia - (ADL);Auckland, New Zealand - (AKL);Brisbane, QLD, Australia - (BNE);Melbourne, VIC, Australia - (MEL);Noumea, New caledonia - (NOU);Perth, WA, Australia - (PER);Sydney, NSW, Australia - (SYD)".split(";"),e=a.split("colo=")[1].split("\n")[0],t=(a.split("colo=")[1].split("\n")[0],a.split("tls=")[1].split("\n")[0]),o=a.split("http=")[1].split("\n")[0],s=a.split("sni=")[1].split("\n")[0],r=a.split("ip=")[1].split("\n")[0],l=a.split("uag=")[1].split("\n")[0];for(var d=0;d<i.length;d++)if(-1!=i[d].indexOf(e)){document.getElementById("cdn").innerHTML=i[d];break}document.getElementById("tls").innerHTML=t,document.getElementById("http").innerHTML=o,document.getElementById("sni").innerHTML=s,document.getElementById("ip").innerHTML=r,document.getElementById("useragent").innerHTML=l}})},$(document).ready((function(){getCDNinfo()}))</script></p><p style="text-align:center">感谢陪伴与布道，开源之火不灭。​</p><p style="text-align:center"><script>document.write("本次加载耗时: "+(performance.getEntriesByType("navigation").reduce((e,r)=>e+r.responseEnd-r.startTime,0)+performance.getEntriesByType("resource").reduce((e,r)=>e+r.responseEnd-r.startTime,0)).toFixed(0)+"ms")</script></p><p style="text-align:center">当前 SNI 状态： <span id="sni">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 TLS 版本： <span id="tls">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 HTTP 版本： <span id="http">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前您的客户端 IP 是： <span id="ip">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前分配的 CDN 节点是: <span id="cdn">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">您的 UserAgent 信息是: <span id="useragent">正在统计！或可能被浏览器防追踪拦截！</span></p><p></p></div></div></body></html>