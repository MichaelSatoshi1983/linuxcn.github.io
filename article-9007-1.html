<!doctype html><html lang="en"><head><meta name="msvalidate.01" content="D404690CEFCB54C7762AC84935B99171"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6618da70c90c8744eead2e9371fb5077";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,s,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/s5f3f0tojf",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/theme.css"><link rel="shortcut icon" href="/favicon.png"><title>使用 Docker 构建你的 Serverless 树莓派集群 - 归墟星火集</title><meta name="generator" content="Hexo 7.3.0"></head><body><div class="header-title"><span class="header-light"></span> <span class="header-light"></span> <span class="header-light"></span> <span>归墟星火集 linuxcn.undefined.today<span></span></span></div><div class="container"><ul class="nav"><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li><li><a target="_blank" rel="noopener" href="https://undefined.today/">Blog</a></li></ul><div class="content"><div class="post-container"><div class="post-header"><span class="ui-tips">标题：</span><h1 class="ui-keyword post-title">使用 Docker 构建你的 Serverless 树莓派集群</h1><span class="post-date">2017-10-28</span></div><div class="post-header"><span class="ui-tips">分类：</span> <a href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a></div><div class="post-header"><span class="ui-tips">标签：</span> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a> <a href="/tags/Docker/">Docker</a> <a href="/tags/OpenFaaS/">OpenFaaS</a></div><div class="post-content"><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223210p2s4am8lj55amy5j.jpg"></p><p>这篇博文将向你展示如何使用 Docker 和 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a> 框架构建你自己的 Serverless 树莓派集群。大家常常问我能用他们的集群来做些什么？而这个应用完美匹配卡片尺寸的设备——只需添加更多的树莓派就能获取更强的计算能力。</p><blockquote><p>“Serverless” （无服务器）是事件驱动架构的一种设计模式，与“桥接模式”、“外观模式”、“工厂模式”和“云”这些名词一样，都是一种抽象概念。</p></blockquote><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223221o3uuquzstbt9iyz1.jpg"></p><p><em>图片：3 个 Raspberry Pi Zero</em></p><p>这是我在本文中描述的集群，用黄铜支架分隔每个设备。</p><h3 id="Serverless-是什么？它为何重要？"><a href="#Serverless-是什么？它为何重要？" class="headerlink" title="Serverless 是什么？它为何重要？"></a>Serverless 是什么？它为何重要？</h3><p>行业对于 “serverless” 这个术语的含义有几种解释。在这篇博文中，我们就把它理解为一种事件驱动的架构模式，它能让你用自己喜欢的任何语言编写轻量可复用的功能。<a target="_blank" rel="noopener" href="https://blog.alexellis.io/introducing-functions-as-a-service/">更多关于 Serverless 的资料</a>。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223221iq6h44fbthejhs4a.png"></p><p><em>Serverless 架构也引出了“功能即服务服务”模式，简称 FaaS</em></p><p>Serverless 的“功能”可以做任何事，但通常用于处理给定的输入——例如来自 GitHub、Twitter、PayPal、Slack、Jenkins CI pipeline 的事件；或者以树莓派为例，处理像红外运动传感器、激光绊网、温度计等真实世界的传感器的输入。</p><p>Serverless 功能能够更好地结合第三方的后端服务，使系统整体的能力大于各部分之和。</p><p>了解更多背景信息，可以阅读我最近一偏博文：<a target="_blank" rel="noopener" href="https://blog.alexellis.io/introducing-functions-as-a-service/">功能即服务（FaaS）简介</a>。</p><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>我们将使用 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a>，它能够让主机或者集群作为支撑 Serverless 功能运行的后端。任何能够使用 Docker 部署的可执行二进制文件、脚本或者编程语言都能在 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a> 上运作，你可以根据速度和伸缩性选择部署的规模。另一个优点是，它还内建了用户界面和监控系统。</p><p>这是我们要执行的步骤：</p><ul><li>在一个或多个主机上配置 Docker （树莓派 2 或者 3）；</li><li>利用 Docker Swarm 将它们连接；</li><li>部署 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a>；</li><li>使用 Python 编写我们的第一个功能。</li></ul><h3 id="Docker-Swarm"><a href="#Docker-Swarm" class="headerlink" title="Docker Swarm"></a>Docker Swarm</h3><p>Docker 是一项打包和部署应用的技术，支持集群上运行，有着安全的默认设置，而且在搭建集群时只需要一条命令。OpenFaaS 使用 Docker 和 Swarm 在你的可用树莓派上传递你的 Serverless 功能。</p><p>我推荐你在这个项目中使用带树莓派 2 或者 3，以太网交换机和<a target="_blank" rel="noopener" href="https://www.amazon.co.uk/Anker-PowerPort-Family-Sized-Technology-Smartphones/dp/B00PK1IIJY">强大的 USB 多端口电源适配器</a>。</p><h3 id="准备-Raspbian"><a href="#准备-Raspbian" class="headerlink" title="准备 Raspbian"></a>准备 Raspbian</h3><p>把 <a target="_blank" rel="noopener" href="http://downloads.raspberrypi.org/raspbian/images/raspbian-2017-07-05/">Raspbian Jessie Lite</a> 写入 SD 卡（8GB 容量就正常工作了，但还是推荐使用 16GB 的 SD 卡）。</p><p><em>注意：不要下载成 Raspbian Stretch 了</em></p><blockquote><p>社区在努力让 Docker 支持 Raspbian Stretch，但是还未能做到完美运行。请从<a target="_blank" rel="noopener" href="http://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2017-07-05/">树莓派基金会网站</a>下载 Jessie Lite 镜像。</p></blockquote><p>我推荐使用 <a target="_blank" rel="noopener" href="https://etcher.io/">Etcher.io</a> 烧写镜像。</p><blockquote><p>在引导树莓派之前，你需要在引导分区创建名为 <code>ssh</code> 的空白文件。这样才能允许远程登录。</p></blockquote><h4 id="接通电源，然后修改主机名"><a href="#接通电源，然后修改主机名" class="headerlink" title="接通电源，然后修改主机名"></a>接通电源，然后修改主机名</h4><p>现在启动树莓派的电源并且使用 <code>ssh</code> 连接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh pi@raspberrypi.local</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>默认密码是 <code>raspberry</code></p></blockquote><p>使用 <code>raspi-config</code> 工具把主机名改为 <code>swarm-1</code> 或者类似的名字，然后重启。</p><p>当你到了这一步，你还可以把划分给 GPU （显卡）的内存设置为 16MB。</p><h4 id="现在安装-Docker"><a href="#现在安装-Docker" class="headerlink" title="现在安装 Docker"></a>现在安装 Docker</h4><p>我们可以使用通用脚本来安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sSL https://get.docker.com | sh</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这个安装方式在将来可能会发生变化。如上文所说，你的系统需要是 Jessie，这样才能得到一个确定的配置。</p></blockquote><p>你可能会看到类似下面的警告，不过你可以安全地忽略它并且成功安装上 Docker CE 17.05：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING: raspbian is no longer updated @ https://get.docker.com/  </span><br><span class="line">Installing the legacy docker-engine package...  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后，用下面这个命令确保你的用户帐号可以访问 Docker 客户端：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ usermod pi -aG docker</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>如果你的用户名不是 <code>pi</code>，那就把它替换成你的用户名。</p></blockquote><h4 id="修改默认密码"><a href="#修改默认密码" class="headerlink" title="修改默认密码"></a>修改默认密码</h4><p>输入 <code>$sudo passwd pi</code>，然后设置一个新密码，请不要跳过这一步！</p><h4 id="重复以上步骤"><a href="#重复以上步骤" class="headerlink" title="重复以上步骤"></a>重复以上步骤</h4><p>现在为其它的树莓派重复上述步骤。</p><h3 id="创建你的-Swarm-集群"><a href="#创建你的-Swarm-集群" class="headerlink" title="创建你的 Swarm 集群"></a>创建你的 Swarm 集群</h3><p>登录你的第一个树莓派，然后输入下面的命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init</span><br><span class="line">Swarm initialized: current node (3ra7i5ldijsffjnmubmsfh767) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join \</span><br><span class="line">    --token SWMTKN-1-496mv9itb7584pzcddzj4zvzzfltgud8k75rvujopw15n3ehzu-af445b08359golnzhncbdj9o3 \</span><br><span class="line">    192.168.0.79:2377</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你会看到它显示了一个口令，以及其它节点加入集群的命令。接下来使用 <code>ssh</code> 登录每个树莓派，运行这个加入集群的命令。</p><p>等待连接完成后，在第一个树莓派上查看集群的节点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS  </span><br><span class="line">3ra7i5ldijsffjnmubmsfh767 *   swarm1              Ready               Active              Leader  </span><br><span class="line">k9mom28s2kqxocfq1fo6ywu63     swarm3              Ready               Active  </span><br><span class="line">y2p089bs174vmrlx30gc77h4o     swarm4              Ready               Active  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>恭喜你！你现在拥有一个树莓派集群了！</p><h4 id="更多关于集群的内容"><a href="#更多关于集群的内容" class="headerlink" title="更多关于集群的内容"></a>更多关于集群的内容</h4><p>你可以看到三个节点启动运行。这时只有一个节点是集群管理者。如果我们的管理节点<em>死机</em>了，集群就进入了不可修复的状态。我们可以通过添加冗余的管理节点解决这个问题。而且它们依然会运行工作负载，除非你明确设置了让你的服务只运作在工作节点上。</p><p>要把一个工作节点升级为管理节点，只需要在其中一个管理节点上运行 <code>docker node promote &lt;node_name&gt;</code> 命令。</p><blockquote><p>注意： Swarm 命令，例如 <code>docker service ls</code> 或者 <code>docker node ls</code> 只能在管理节点上运行。</p></blockquote><p>想深入了解管理节点与工作节点如何保持一致性，可以查阅 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/admin_guide/">Docker Swarm 管理指南</a>。</p><h3 id="OpenFaaS"><a href="#OpenFaaS" class="headerlink" title="OpenFaaS"></a>OpenFaaS</h3><p>现在我们继续部署程序，让我们的集群能够运行 Serverless 功能。<a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a> 是一个利用 Docker 在任何硬件或者云上让任何进程或者容器成为一个 Serverless 功能的框架。因为 Docker 和 Golang 的可移植性，它也能很好地运行在树莓派上。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223229u8118z3xcxcx8zx1.png"></p><blockquote><p>如果你支持 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a>，希望你能 <strong>星标</strong> <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">OpenFaaS</a> 的 GitHub 仓库。</p></blockquote><p>登录你的第一个树莓派（你运行 <code>docker swarm init</code> 的节点），然后部署这个项目：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/alexellis/faas/</span><br><span class="line">$ cd faas</span><br><span class="line">$ ./deploy_stack.armhf.sh</span><br><span class="line">Creating network func_functions  </span><br><span class="line">Creating service func_gateway  </span><br><span class="line">Creating service func_prometheus  </span><br><span class="line">Creating service func_alertmanager  </span><br><span class="line">Creating service func_nodeinfo  </span><br><span class="line">Creating service func_markdown  </span><br><span class="line">Creating service func_wordcount  </span><br><span class="line">Creating service func_echoit  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你的其它树莓派会收到 Docer Swarm 的指令，开始从网上拉取这个 Docker 镜像，并且解压到 SD 卡上。这些工作会分布到各个节点上，所以没有哪个节点产生过高的负载。</p><p>这个过程会持续几分钟，你可以用下面指令查看它的完成状况：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ watch &#x27;docker service ls&#x27;</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                                   PORTS  </span><br><span class="line">57ine9c10xhp        func_wordcount      replicated          1/1                 functions/alpine:latest-armhf  </span><br><span class="line">d979zipx1gld        func_prometheus     replicated          1/1                 alexellis2/prometheus-armhf:1.5.2       *:9090-&gt;9090/tcp  </span><br><span class="line">f9yvm0dddn47        func_echoit         replicated          1/1                 functions/alpine:latest-armhf  </span><br><span class="line">lhbk1fc2lobq        func_markdown       replicated          1/1                 functions/markdownrender:latest-armhf  </span><br><span class="line">pj814yluzyyo        func_alertmanager   replicated          1/1                 alexellis2/alertmanager-armhf:0.5.1     *:9093-&gt;9093/tcp  </span><br><span class="line">q4bet4xs10pk        func_gateway        replicated          1/1                 functions/gateway-armhf:0.6.0           *:8080-&gt;8080/tcp  </span><br><span class="line">v9vsvx73pszz        func_nodeinfo       replicated          1/1                 functions/nodeinfo:latest-armhf  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们希望看到每个服务都显示 “1&#x2F;1”。</p><p>你可以根据服务名查看该服务被调度到哪个树莓派上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker service ps func_markdown</span><br><span class="line">ID                  IMAGE                                   NODE    STATE  </span><br><span class="line">func_markdown.1     functions/markdownrender:latest-armhf   swarm4  Running  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>状态一项应该显示 <code>Running</code>，如果它是 <code>Pending</code>，那么镜像可能还在下载中。</p><p>在这时，查看树莓派的 IP 地址，然后在浏览器中访问它的 8080 端口：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例如，如果你的 IP 地址是 192.168.0.100，那就访问 <a target="_blank" rel="noopener" href="http://192.168.0.100:8080/">http://192.168.0.100:8080</a> 。</p><p>这是你会看到 FaaS UI（也叫 API 网关）。这是你定义、测试、调用功能的地方。</p><p>点击名称为 “func_markdown” 的 Markdown 转换功能，输入一些 Markdown（这是 Wikipedia 用来组织内容的语言）文本。</p><p>然后点击 “invoke”。你会看到调用计数增加，屏幕下方显示功能调用的结果。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223229fpnm7byd4tx33bbm.png"></p><h3 id="部署你的第一个-Serverless-功能："><a href="#部署你的第一个-Serverless-功能：" class="headerlink" title="部署你的第一个 Serverless 功能："></a>部署你的第一个 Serverless 功能：</h3><p>这一节的内容已经有相关的教程，但是我们需要几个步骤来配置树莓派。</p><h4 id="获取-FaaS-CLI"><a href="#获取-FaaS-CLI" class="headerlink" title="获取 FaaS-CLI"></a>获取 FaaS-CLI</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -sSL cli.openfaas.com | sudo sh</span><br><span class="line">armv7l  </span><br><span class="line">Getting package https://github.com/alexellis/faas-cli/releases/download/0.4.5-b/faas-cli-armhf  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="下载样例"><a href="#下载样例" class="headerlink" title="下载样例"></a>下载样例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/alexellis/faas-cli</span><br><span class="line">$ cd faas-cli</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="为树莓派修补样例模版"><a href="#为树莓派修补样例模版" class="headerlink" title="为树莓派修补样例模版"></a>为树莓派修补样例模版</h4><p>我们临时修改我们的模版，让它们能在树莓派上工作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp template/node-armhf/Dockerfile template/node/</span><br><span class="line">$ cp template/python-armhf/Dockerfile template/python/</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这么做是因为树莓派和我们平时关注的大多数计算机使用不一样的处理器架构。</p><blockquote><p>了解 Docker 在树莓派上的最新状况，请查阅： <a target="_blank" rel="noopener" href="https://blog.alexellis.io/5-things-docker-rpi/">你需要了解的五件事</a>。</p></blockquote><p>现在你可以跟着下面为 PC、笔记本和云端所写的教程操作，但我们在树莓派上要先运行一些命令。</p><ul><li><a target="_blank" rel="noopener" href="https://blog.alexellis.io/first-faas-python-function">使用 OpenFaaS 运行你的第一个 Serverless Python 功能</a></li></ul><p>注意第 3 步：</p><ul><li>把你的功能放到先前从 GitHub 下载的 <code>faas-cli</code> 文件夹中，而不是 <code>~/functinos/hello-python</code> 里。</li><li>同时，在 <code>stack.yml</code> 文件中把 <code>localhost</code> 替换成第一个树莓派的 IP 地址。</li></ul><p>集群可能会花费几分钟把 Serverless 功能下载到相关的树莓派上。你可以用下面的命令查看你的服务，确保副本一项显示 “1&#x2F;1”：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ watch &#x27;docker service ls&#x27;</span><br><span class="line">pv27thj5lftz        hello-python        replicated          1/1                 alexellis2/faas-hello-python-armhf:latest  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>继续阅读教程：</strong> <a target="_blank" rel="noopener" href="https://blog.alexellis.io/first-faas-python-function">使用 OpenFaaS 运行你的第一个 Serverless Python 功能</a></p><p>关于 Node.js 或者其它语言的更多信息，可以进一步访问 <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">FaaS 仓库</a>。</p><h3 id="检查功能的指标"><a href="#检查功能的指标" class="headerlink" title="检查功能的指标"></a>检查功能的指标</h3><p>既然使用 Serverless，你也不想花时间监控你的功能。幸运的是，OpenFaaS 内建了 <a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a> 指标检测，这意味着你可以追踪每个功能的运行时长和调用频率。</p><h4 id="指标驱动自动伸缩"><a href="#指标驱动自动伸缩" class="headerlink" title="指标驱动自动伸缩"></a>指标驱动自动伸缩</h4><p>如果你给一个功能生成足够的负载，OpenFaaS 将自动扩展你的功能；当需求消失时，你又会回到单一副本的状态。</p><p>这个请求样例你可以复制到浏览器中：</p><p>只要把 IP 地址改成你的即可。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223230qnr5rgeg0zgv2erc.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.25:9090/graph?g0.range_input=15m&amp;g0.stacked=1&amp;g0.expr=rate(gateway_function_invocation_total%5B20s%5D)&amp;g0.tab=0&amp;g1.range_input=1h&amp;g1.expr=gateway_service_count&amp;g1.tab=0  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这些请求使用 PromQL（Prometheus 请求语言）编写。第一个请求返回功能调用的频率：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rate(gateway_function_invocation_total[20s])  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>第二个请求显示每个功能的副本数量，最开始应该是每个功能只有一个副本。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gateway_service_count  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>如果你想触发自动扩展，你可以在树莓派上尝试下面指令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ while [ true ]; do curl -4 localhost:8080/function/func_echoit --data &quot;hello world&quot; ; done</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>查看 Prometheus 的 “alerts” 页面，可以知道你是否产生足够的负载来触发自动扩展。如果没有，你可以尝试在多个终端同时运行上面的指令。</p><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/201710/28/223231yf17n5n4a7m4x3no.png"></p><p>当你降低负载，副本数量显示在你的第二个图表中，并且 <code>gateway_service_count</code> 指标再次降回 1。</p><h3 id="结束演讲"><a href="#结束演讲" class="headerlink" title="结束演讲"></a>结束演讲</h3><p>我们现在配置好了 Docker、Swarm， 并且让 OpenFaaS 运行代码，把树莓派像大型计算机一样使用。</p><blockquote><p>希望大家支持这个项目，<strong>星标</strong> <a target="_blank" rel="noopener" href="https://github.com/alexellis/faas">FaaS 的 GitHub 仓库</a>。</p></blockquote><p>你是如何搭建好了自己的 Docker Swarm 集群并且运行 OpenFaaS 的呢？在 Twitter <a target="_blank" rel="noopener" href="https://twitter.com/alexellisuk">@alexellisuk</a> 上分享你的照片或推文吧。</p><p><strong>观看我在 Dockercon 上关于 OpenFaaS 的视频</strong></p><p>我在 <a target="_blank" rel="noopener" href="https://blog.alexellis.io/dockercon-2017-captains-log/">Austin 的 Dockercon</a> 上展示了 OpenFaaS。——观看介绍和互动例子的视频： <a target="_blank" rel="noopener" href="https://www.youtube.com/embed/-h2VTE9WnZs">https://www.youtube.com/embed/-h2VTE9WnZs</a></p><p>有问题？在下面的评论中提出，或者给我发邮件，邀请我进入你和志同道合者讨论树莓派、Docker、Serverless 的 Slack channel。</p><p><strong>想要学习更多关于树莓派上运行 Docker 的内容？</strong></p><p>我建议从 <a target="_blank" rel="noopener" href="https://blog.alexellis.io/5-things-docker-rpi/">你需要了解的五件事</a> 开始，它包含了安全性、树莓派和普通 PC 间微妙差别等话题。</p><ul><li><a target="_blank" rel="noopener" href="https://blog.alexellis.io/dockercon-tips-docker-raspberry-pi/">Dockercon tips: Docker &amp; Raspberry Pi</a></li><li><a target="_blank" rel="noopener" href="https://blog.alexellis.io/gpio-on-swarm/">Control GPIO with Docker Swarm</a></li><li><a target="_blank" rel="noopener" href="https://blog.alexellis.io/docker-engine-in-your-pocket/">Is that a Docker Engine in your pocket??</a></li></ul><hr><p>via: <a target="_blank" rel="noopener" href="https://blog.alexellis.io/your-serverless-raspberry-pi-cluster/">https://blog.alexellis.io/your-serverless-raspberry-pi-cluster/</a></p><p>作者：<a target="_blank" rel="noopener" href="https://twitter.com/alexellisuk">Alex Ellis</a> 译者：<a target="_blank" rel="noopener" href="https://github.com/haoqixu">haoqixu</a> 校对：<a target="_blank" rel="noopener" href="https://github.com/wxy">wxy</a></p><p>本文由 <a target="_blank" rel="noopener" href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a target="_blank" rel="noopener" href="https://linux.cn/">Linux中国</a> 荣誉推出</p></div></div></div><div class="footer"><p class="footer-copyright"><span>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></span> <span>Theme <a target="_blank" href="https://github.com/tinkink-co/hexo-theme-terminal">Terminal</a></span><script type="text/javascript" src="https://cdn.staticfile.net/jquery/3.4.1/jquery.min.js"></script><script>getCDNinfo=function(){$.ajax({url:"/cdn-cgi/trace",success:function(a,n){let i="Antananarivo, Madagascar - (TNR);Cape Town, South Africa - (CPT);Casablanca, Morocco - (CMN);Dar Es Salaam, Tanzania - (DAR);Djibouti City, Djibouti - (JIB);Durban, South Africa - (DUR);Johannesburg, South Africa - (JNB);Kigali, Rwanda - (KGL);Lagos, Nigeria - (LOS);Luanda, Angola - (LAD);Maputo, MZ - (MPM);Mombasa, Kenya - (MBA);Port Louis, Mauritius - (MRU);Réunion, France - (RUN);Bangalore, India - (BLR);Bangkok, Thailand - (BKK);Bandar Seri Begawan, Brunei - (BWN);Cebu, Philippines - (CEB);Chengdu, China - (CTU);Chennai, India - (MAA);Chittagong, Bangladesh - (CGP);Chongqing, China - (CKG);Colombo, Sri Lanka - (CMB);Dhaka, Bangladesh - (DAC);Dongguan, China - (SZX);Foshan, China - (FUO);Fuzhou, China - (FOC);Guangzhou, China - (CAN);Hangzhou, China - (HGH);Hanoi, Vietnam - (HAN);Hengyang, China - (HNY);Ho Chi Minh City, Vietnam - (SGN);Hong Kong - (HKG);Hyderabad, India - (HYD);Islamabad, Pakistan - (ISB);Jakarta, Indonesia - (CGK);Jinan, China - (TNA);Karachi, Pakistan - (KHI);Kathmandu, Nepal - (KTM);Kolkata, India - (CCU);Kuala Lumpur, Malaysia - (KUL);Lahore, Pakistan - (LHE);Langfang, China - (NAY);Luoyang, China - (LYA);Macau - (MFM);Malé, Maldives - (MLE);Manila, Philippines - (MNL);Mumbai, India - (BOM);Nagpur, India - (NAG);Nanning, China - (NNG);New Delhi, India - (DEL);Osaka, Japan - (KIX);Phnom Penh, Cambodia - (PNH);Qingdao, China - (TAO);Seoul, South Korea - (ICN);Shanghai, China - (SHA);Shenyang, China - (SHE);Shijiazhuang, China - (SJW);Singapore, Singapore - (SIN);Suzhou, China - (SZV);Taipei - (TPE);Thimphu, Bhutan - (PBH);Tianjin, China - (TSN);Tokyo, Japan - (NRT);Ulaanbaatar, Mongolia - (ULN);Vientiane, Laos - (VTE);Wuhan, China - (WUH);Wuxi, China - (WUX);Xi'an, China - (XIY);Yerevan, Armenia - (EVN);Zhengzhou, China - (CGO);Zuzhou, China - (CSX);Amsterdam, Netherlands - (AMS);Athens, Greece - (ATH);Barcelona, Spain - (BCN);Belgrade, Serbia - (BEG);Berlin, Germany - (TXL);Brussels, Belgium - (BRU);Bucharest, Romania - (OTP);Budapest, Hungary - (BUD);Chișinău, Moldova - (KIV);Copenhagen, Denmark - (CPH);Cork, Ireland -  (ORK);Dublin, Ireland - (DUB);Düsseldorf, Germany - (DUS);Edinburgh, United Kingdom - (EDI);Frankfurt, Germany - (FRA);Geneva, Switzerland - (GVA);Gothenburg, Sweden - (GOT);Hamburg, Germany - (HAM);Helsinki, Finland - (HEL);Istanbul, Turkey - (IST);Kyiv, Ukraine - (KBP);Lisbon, Portugal - (LIS);London, United Kingdom - (LHR);Luxembourg City, Luxembourg - (LUX);Madrid, Spain - (MAD);Manchester, United Kingdom - (MAN);Marseille, France - (MRS);Milan, Italy - (MXP);Moscow, Russia - (DME);Munich, Germany - (MUC);Nicosia, Cyprus - (LCA);Oslo, Norway - (OSL);Paris, France - (CDG);Prague, Czech Republic - (PRG);Reykjavík, Iceland - (KEF);Riga, Latvia - (RIX);Rome, Italy - (FCO);Saint Petersburg, Russia - (LED);Sofia, Bulgaria - (SOF);Stockholm, Sweden - (ARN);Tallinn, Estonia - (TLL);Thessaloniki, Greece - (SKG);Vienna, Austria - (VIE);Vilnius, Lithuania - (VNO);Warsaw, Poland - (WAW);Zagreb, Croatia - (ZAG);Zürich, Switzerland - (ZRH);Arica, Chile - (ARI);Asunción, Paraguay - (ASU);Bogotá, Colombia - (BOG);Buenos Aires, Argentina - (EZE);Curitiba, Brazil - (CWB);Fortaleza, Brazil - (FOR);Guatemala City, Guatemala - (GUA);Lima, Peru - (LIM);Medellín, Colombia - (MDE);Panama City, Panama - (PTY);Porto Alegre, Brazil - (POA);Quito, Ecuador - (UIO);Rio de Janeiro, Brazil - (GIG);São Paulo, Brazil - (GRU);Santiago, Chile - (SCL);Willemstad, Curaçao - (CUR);St. George's, Grenada - (GND);Amman, Jordan - (AMM);Baghdad, Iraq - (BGW);Baku, Azerbaijan - (GYD);Beirut, Lebanon - (BEY);Doha, Qatar - (DOH);Dubai, United Arab Emirates - (DXB);Kuwait City, Kuwait - (KWI);Manama, Bahrain - (BAH);Muscat, Oman - (MCT);Ramallah - (ZDM);Riyadh, Saudi Arabia - (RUH);Tel Aviv, Israel - (TLV);Ashburn, VA, United States - (IAD);Atlanta, GA, United States - (ATL);Boston, MA, United States - (BOS);Buffalo, NY, United States - (BUF);Calgary, AB, Canada - (YYC);Charlotte, NC, United States - (CLT);Chicago, IL, United States - (ORD);Columbus, OH, United States - (CMH);Dallas, TX, United States - (DFW);Denver, CO, United States - (DEN);Detroit, MI, United States - (DTW);Honolulu, HI, United States - (HNL);Houston, TX, United States - (IAH);Indianapolis, IN, United States - (IND);Jacksonville, FL, United States - (JAX);Kansas City, MO, United States - (MCI);Las Vegas, NV, United States - (LAS);Los Angeles, CA, United States - (LAX);McAllen, TX, United States - (MFE);Memphis, TN, United States - (MEM);Mexico City, Mexico - (MEX);Miami, FL, United States - (MIA);Minneapolis, MN, United States - (MSP);Montgomery, AL, United States - (MGM);Montréal, QC, Canada - (YUL);Nashville, TN, United States - (BNA);Newark, NJ, United States - (EWR);Norfolk, VA, United States - (ORF);Omaha, NE, United States - (OMA);Philadelphia, United States - (PHL);Phoenix, AZ, United States - (PHX);Pittsburgh, PA, United States - (PIT);Port-Au-Prince, Haiti - (PAP);Portland, OR, United States - (PDX);Queretaro, MX, Mexico - (QRO);Richmond, Virginia - (RIC);Sacramento, CA, United States - (SMF);Salt Lake City, UT, United States - (SLC);San Diego, CA, United States - (SAN);San Jose, CA, United States - (SJC);Saskatoon, SK, Canada - (YXE);Seattle, WA, United States - (SEA);St. Louis, MO, United States - (STL);Tampa, FL, United States - (TPA);Toronto, ON, Canada - (YYZ);Vancouver, BC, Canada - (YVR);Tallahassee, FL, United States - (TLH);Winnipeg, MB, Canada - (YWG);Adelaide, SA, Australia - (ADL);Auckland, New Zealand - (AKL);Brisbane, QLD, Australia - (BNE);Melbourne, VIC, Australia - (MEL);Noumea, New caledonia - (NOU);Perth, WA, Australia - (PER);Sydney, NSW, Australia - (SYD)".split(";"),e=a.split("colo=")[1].split("\n")[0],t=(a.split("colo=")[1].split("\n")[0],a.split("tls=")[1].split("\n")[0]),o=a.split("http=")[1].split("\n")[0],s=a.split("sni=")[1].split("\n")[0],r=a.split("ip=")[1].split("\n")[0],l=a.split("uag=")[1].split("\n")[0];for(var d=0;d<i.length;d++)if(-1!=i[d].indexOf(e)){document.getElementById("cdn").innerHTML=i[d];break}document.getElementById("tls").innerHTML=t,document.getElementById("http").innerHTML=o,document.getElementById("sni").innerHTML=s,document.getElementById("ip").innerHTML=r,document.getElementById("useragent").innerHTML=l}})},$(document).ready((function(){getCDNinfo()}))</script></p><p style="text-align:center">感谢陪伴与布道，开源之火不灭。​</p><p style="text-align:center"><script>document.write("本次加载耗时: "+(performance.getEntriesByType("navigation").reduce((e,r)=>e+r.responseEnd-r.startTime,0)+performance.getEntriesByType("resource").reduce((e,r)=>e+r.responseEnd-r.startTime,0)).toFixed(0)+"ms")</script></p><p style="text-align:center">当前 SNI 状态： <span id="sni">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 TLS 版本： <span id="tls">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 HTTP 版本： <span id="http">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前您的客户端 IP 是： <span id="ip">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前分配的 CDN 节点是: <span id="cdn">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">您的 UserAgent 信息是: <span id="useragent">正在统计！或可能被浏览器防追踪拦截！</span></p><p></p></div></div></body></html>