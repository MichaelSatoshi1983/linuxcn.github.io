<!doctype html><html lang="en"><head><meta name="msvalidate.01" content="D404690CEFCB54C7762AC84935B99171"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6618da70c90c8744eead2e9371fb5077";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,c,s,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/s5f3f0tojf",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta http-equiv="X-UA-Compatible" content="ie=edge"><link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/theme.css"><link rel="shortcut icon" href="/favicon.png"><title>在 Git 仓库中，文件究竟被存储在哪里？ - 归墟星火集</title><meta name="generator" content="Hexo 7.3.0"></head><body><div class="header-title"><span class="header-light"></span> <span class="header-light"></span> <span class="header-light"></span> <span>归墟星火集 linuxcn.undefined.today<span></span></span></div><div class="container"><ul class="nav"><li><a href="/">首页</a></li><li><a href="/about/">关于</a></li><li><a target="_blank" rel="noopener" href="https://undefined.today/">Blog</a></li></ul><div class="content"><div class="post-container"><div class="post-header"><span class="ui-tips">标题：</span><h1 class="ui-keyword post-title">在 Git 仓库中，文件究竟被存储在哪里？</h1><span class="post-date">2023-09-16</span></div><div class="post-header"><span class="ui-tips">分类：</span> <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></div><div class="post-header"><span class="ui-tips">标签：</span> <a href="/tags/Git/">Git</a></div><div class="post-content"><p><img src="https://linuxcn.img.undefined.today/data/attachment/album/202309/16/230138n1j44qiabgplgbw4.jpg"></p><p>大家好！今天我和一个朋友讨论 Git 的工作原理，我们感到奇怪，Git 是如何存储你的文件的？我们知道它存储在 <code>.git</code> 目录中，但具体到 <code>.git</code> 中的哪个位置，各个版本的历史文件又被存储在哪里呢？</p><p>以这个博客为例，其文件存储在一个 Git 仓库中，其中有一个文件名为 <code>content/post/2019-06-28-brag-doc.markdown</code>。这个文件在我的 <code>.git</code> 文件夹中具体的位置在哪里？过去的文件版本又被存储在哪里？那么，就让我们通过编写一些简短的 Python 代码来探寻答案吧。</p><h3 id="Git-把文件存储在-git-objects-之中"><a href="#Git-把文件存储在-git-objects-之中" class="headerlink" title="Git 把文件存储在 .git&#x2F;objects 之中"></a>Git 把文件存储在 .git&#x2F;objects 之中</h3><p>你的仓库中，每一个文件的历史版本都被储存在 <code>.git/objects</code> 中。比如，对于这个博客，<code>.git/objects</code> 包含了 2700 多个文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects/ -type f | wc -l</span><br><span class="line">2761</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意：<code>.git/objects</code> 包含的信息，不仅仅是 “仓库中每一个文件的所有先前版本”，但我们暂不详细讨论这一内容。</p></blockquote><p>这里是一个简短的 Python 程序（<a target="_blank" rel="noopener" href="https://gist.github.com/jvns/ff884dceef7660402fe1eca697cfbf51">find-git-object.py</a>），它可以帮助我们定位在 <code>.git/objects</code> 中的特定文件的具体位置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def object_path(content):</span><br><span class="line">    header = f&quot;blob &#123;len(content)&#125;\0&quot;</span><br><span class="line">    data = header.encode() + content</span><br><span class="line">    sha1 = hashlib.sha1()</span><br><span class="line">    sha1.update(data)</span><br><span class="line">    digest = sha1.hexdigest()</span><br><span class="line">    return f&quot;.git/objects/&#123;digest[:2]&#125;/&#123;digest[2:]&#125;&quot;</span><br><span class="line"></span><br><span class="line">with open(sys.argv[1], &quot;rb&quot;) as f:</span><br><span class="line">    print(object_path(f.read()))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此程序的主要操作如下：</p><ul><li>读取文件内容</li><li>计算一个头部（<code>blob 16673\0</code>），并将其与文件内容合并</li><li>计算出文件的 sha1 校验和（此处为 <code>e33121a9af82dd99d6d706d037204251d41d54</code>）</li><li>将这个 sha1 校验和转换为路径（如 <code>.git/objects/e3/3121a9af82dd99d6d706d037204251d41d54</code>）</li></ul><p>运行的方法如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python3 find-git-object.py content/post/2019-06-28-brag-doc.markdown</span><br><span class="line">.git/objects/8a/e33121a9af82dd99d6d706d037204251d41d54</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="术语解释：“内容寻址存储”"><a href="#术语解释：“内容寻址存储”" class="headerlink" title="术语解释：“内容寻址存储”"></a>术语解释：“内容寻址存储”</h3><p>这种存储策略的术语为“<ruby>内容寻址存储 <rt>content addressed storage</rt></ruby>”，它指的是对象在数据库中的文件名与文件内容的哈希值相同。</p><p>内容寻址存储的有趣之处就是，假设我有两份或许多份内容完全相同的文件，在 Git 的数据库中，并不会因此占用额外空间。如果内容的哈希值是 <code>aabbbbbbbbbbbbbbbbbbbbbbbbb</code>，它们都会被存储在 <code>.git/objects/aa/bbbbbbbbbbbbbbbbbbbbb</code> 中。</p><h3 id="这些对象是如何进行编码的？"><a href="#这些对象是如何进行编码的？" class="headerlink" title="这些对象是如何进行编码的？"></a>这些对象是如何进行编码的？</h3><p>如果我尝试在 <code>.git/objects</code> 目录下查看这个文件，显示的内容似乎有一些奇怪：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/objects/8a/e33121a9af82dd99d6d706d037204251d41d54</span><br><span class="line">x^A&lt;8D&gt;&lt;9B&gt;&#125;s&lt;E3&gt;Ƒ&lt;C6&gt;&lt;EF&gt;o|&lt;8A&gt;^Q&lt;9D&gt;&lt;EC&gt;ju&lt;92&gt;&lt;E8&gt;&lt;DD&gt;&lt;9C&gt;&lt;9C&gt;*&lt;89&gt;j&lt;FD&gt;^...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是怎么回事呢？让我们来运行 <code>file</code> 命令检查一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ file .git/objects/8a/e33121a9af82dd99d6d706d037204251d41d54</span><br><span class="line">.git/objects/8a/e33121a9af82dd99d6d706d037204251d41d54: zlib compressed data</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>原来，它是压缩的！我们可以编写一个小巧的 Python 程序—— <code>decompress.py</code>，然后用 <code>zlib</code> 模块去解压这些数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import zlib</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">with open(sys.argv[1], &quot;rb&quot;) as f:</span><br><span class="line">    content = f.read()</span><br><span class="line">    print(zlib.decompress(content).decode())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>让我们来解压一下看看结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python3 decompress.py .git/objects/8a/e33121a9af82dd99d6d706d037204251d41d54</span><br><span class="line">blob 16673---</span><br><span class="line">title: &quot;Get your work recognized: write a brag document&quot;</span><br><span class="line">date: 2019-06-28T18:46:02Z</span><br><span class="line">url: /blog/brag-documents/</span><br><span class="line">categories: []</span><br><span class="line">---</span><br><span class="line">... the entire blog post ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结果显示，这些数据的编码方式非常简单：首先有 <code>blob 16673\0</code> 标识，其后就是文件的全部内容。</p><h3 id="这里并没有差异性数据（diff）"><a href="#这里并没有差异性数据（diff）" class="headerlink" title="这里并没有差异性数据（diff）"></a>这里并没有差异性数据（diff）</h3><p>这里有一件我第一次知道时让我感到惊讶的事：这里并没有任何差异性数据！那个文件是该篇博客文章的第 9 个版本，但 Git 在 <code>.git/objects</code> 目录中存储的版本是完整文件内容，而并非与前一版本的差异。</p><p>尽管 Git 实际上有时候会以差异性数据存储文件（例如，当你运行 <code>git gc</code> 时，为了提升效率，它可能会将多个不同的文件封装成 “打包文件”），但在我个人经验中，我从未需要关注这个细节，所以我们不在此深入讨论。然而，关于这种格式如何工作，Aditya Mukerjee 有篇优秀的文章 《<a target="_blank" rel="noopener" href="https://codewords.recurse.com/issues/three/unpacking-git-packfiles">拆解 Git 的打包文件</a>》。</p><h3 id="博客文章的旧版本在哪？"><a href="#博客文章的旧版本在哪？" class="headerlink" title="博客文章的旧版本在哪？"></a>博客文章的旧版本在哪？</h3><p>你可能会好奇：如果在我修复了一些错别字之前，这篇博文已经存在了 8 个版本，那它们在 <code>.git/objects</code> 目录中的位置是哪里？我们如何找到它们呢？</p><p>首先，我们来使用 <code>git log</code> 命令来查找改动过这个文件的每一个提交：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git log --oneline  content/post/2019-06-28-brag-doc.markdown</span><br><span class="line">c6d4db2d</span><br><span class="line">423cd76a</span><br><span class="line">7e91d7d0</span><br><span class="line">f105905a</span><br><span class="line">b6d23643</span><br><span class="line">998a46dd</span><br><span class="line">67a26b04</span><br><span class="line">d9999f17</span><br><span class="line">026c0f52</span><br><span class="line">72442b67</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后，我们选择一个之前的提交，比如 <code>026c0f52</code>。提交也被存储在 <code>.git/objects</code> 中，我们可以尝试在那里找到它。但是失败了！因为 <code>ls .git/objects/02/6c*</code> 没有显示任何内容！如果有人告诉你，“我们知道有时 Git 会打包对象来节省空间，我们并不需过多关心它”，但现在，我们需要去面对这个问题了。</p><p>那就让我们去解决它吧。</p><h3 id="让我们开始解包一些对象"><a href="#让我们开始解包一些对象" class="headerlink" title="让我们开始解包一些对象"></a>让我们开始解包一些对象</h3><p>现在我们需要从打包文件中解包出一些对象。我在 Stack Overflow 上查找了一下，看起来我们可以这样进行操作：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mv .git/objects/pack/pack-adeb3c14576443e593a3161e7e1b202faba73f54.pack .</span><br><span class="line">$ git unpack-objects &lt; pack-adeb3c14576443e593a3161e7e1b202faba73f54.pack</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这种直接对库进行手术式的做法让人有些紧张，但如果我误操作了，我还可以从 Github 上重新克隆这个库，所以我并不太担心。</p><p>解包所有的对象文件后，我们得到了更多的对象：大约有 20000 个，而不是原来的大约 2700 个。看起来很酷。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find .git/objects/ -type f | wc -l</span><br><span class="line">20138</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="我们回头再看看提交"><a href="#我们回头再看看提交" class="headerlink" title="我们回头再看看提交"></a>我们回头再看看提交</h3><p>现在我们可以继续看看我们的提交 <code>026c0f52</code>。我们之前说过 <code>.git/objects</code> 中并不都是文件，其中一部分是提交！为了弄清楚我们的旧文章 <code>content/post/2019-06-28-brag-doc.markdown</code> 是在哪里被保存的，我们需要深入查看这个提交。</p><p>首先，我们需要在 <code>.git/objects</code> 中查看这个提交。</p><h3 id="查看提交的第一步：找到提交"><a href="#查看提交的第一步：找到提交" class="headerlink" title="查看提交的第一步：找到提交"></a>查看提交的第一步：找到提交</h3><p>经过解包后，我们现在可以在 <code>.git/objects/02/6c0f5208c5ea10608afc9252c4a56c1ac1d7e4</code> 中找到提交 <code>026c0f52</code>，我们可以用下面的方法去查看它：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python3 decompress.py .git/objects/02/6c0f5208c5ea10608afc9252c4a56c1ac1d7e4</span><br><span class="line">commit 211tree 01832a9109ab738dac78ee4e95024c74b9b71c27</span><br><span class="line">parent 72442b67590ae1fcbfe05883a351d822454e3826</span><br><span class="line">author Julia Evans &lt;julia@jvns.ca&gt; 1561998673 -0400</span><br><span class="line">committer Julia Evans &lt;julia@jvns.ca&gt; 1561998673 -0400</span><br><span class="line"></span><br><span class="line">brag doc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们也可以用 <code>git cat-file -p 026c0f52</code> 命令来获取相同的信息，这个命令能起到相同的作用，但是它在格式化数据时做得更好一些。（<code>-p</code> 选项意味着它能够以更友好的方式进行格式化）</p><h3 id="查看提交的第二步：找到树"><a href="#查看提交的第二步：找到树" class="headerlink" title="查看提交的第二步：找到树"></a>查看提交的第二步：找到树</h3><p>这个提交包含一个<strong>树</strong>。树是什么呢？让我们看一下。树的 ID 是 <code>01832a9109ab738dac78ee4e95024c74b9b71c27</code>，我们可以使用先前的 <code>decompress.py</code> 脚本查看这个 Git 对象，尽管我不得不移除 <code>.decode()</code> 才能避免脚本崩溃。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3 decompress.py .git/objects/01/832a9109ab738dac78ee4e95024c74b9b71c27</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个输出的格式有些难以阅读。主要的问题在于，该提交的哈希（<code>\xc3\xf7$8\x9b\x8dO\x19/\x18\xb7&#125;|\xc7\xce\x8e…</code>）是原始字节，而没有进行十六进制的编码，因此我们看到 <code>\xc3\xf7$8\x9b\x8d</code> 而非 <code>c3f76024389b8d</code>。我打算切换至 <code>git cat-file -p</code> 命令，它能以更友好的方式显示数据，我不想自己编写一个解析器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 01832a9109ab738dac78ee4e95024c74b9b71c27</span><br><span class="line">100644 blob c3f76024389b8d4f192f18b77d7cc7ce8e3a68ad	.gitignore</span><br><span class="line">100644 blob 7ebaecb311a05e1ca9a43f1eb90f1c6647960bc1	README.md</span><br><span class="line">100644 blob 0f21dc9bf1a73afc89634bac586271384e24b2c9	Rakefile</span><br><span class="line">100644 blob 00b9d54abd71119737d33ee5d29d81ebdcea5a37	config.yaml</span><br><span class="line">040000 tree 61ad34108a327a163cdd66fa1a86342dcef4518e	content &lt;-- 这是我们接下来的目标</span><br><span class="line">040000 tree 6d8543e9eeba67748ded7b5f88b781016200db6f	layouts</span><br><span class="line">100644 blob 22a321a88157293c81e4ddcfef4844c6c698c26f	mystery.rb</span><br><span class="line">040000 tree 8157dc84a37fca4cb13e1257f37a7dd35cfe391e	scripts</span><br><span class="line">040000 tree 84fe9c4cb9cef83e78e90a7fbf33a9a799d7be60	static</span><br><span class="line">040000 tree 34fd3aa2625ba784bced4a95db6154806ae1d9ee	themes</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是我在这次提交时库的根目录中所有的文件。看起来我曾经不小心提交了一个名为 <code>mystery.rb</code> 的文件，后来我删除了它。</p><p>我们的文件在 <code>content</code> 目录中，接下来让我们看看那个树：<code>61ad34108a327a163cdd66fa1a86342dcef4518e</code></p><h3 id="查看提交的第三步：又一棵树"><a href="#查看提交的第三步：又一棵树" class="headerlink" title="查看提交的第三步：又一棵树"></a>查看提交的第三步：又一棵树</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 61ad34108a327a163cdd66fa1a86342dcef4518e</span><br><span class="line">040000 tree 1168078878f9d500ea4e7462a9cd29cbdf4f9a56    about</span><br><span class="line">100644 blob e06d03f28d58982a5b8282a61c4d3cd5ca793005    newsletter.markdown</span><br><span class="line">040000 tree 1f94b8103ca9b6714614614ed79254feb1d9676c    post &lt;-- 我们接下来的目标！</span><br><span class="line">100644 blob 2d7d22581e64ef9077455d834d18c209a8f05302    profiler-project.markdown</span><br><span class="line">040000 tree 06bd3cee1ed46cf403d9d5a201232af5697527bb    projects</span><br><span class="line">040000 tree 65e9357973f0cc60bedaa511489a9c2eeab73c29    talks</span><br><span class="line">040000 tree 8a9d561d536b955209def58f5255fc7fe9523efd    zines</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>还未结束……</p><h3 id="查看提交的第四步：更多的树……"><a href="#查看提交的第四步：更多的树……" class="headerlink" title="查看提交的第四步：更多的树……"></a>查看提交的第四步：更多的树……</h3><p>我们要寻找的文件位于 <code>post/</code> 目录，因此我们需要进一步探索：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git cat-file -p 1f94b8103ca9b6714614614ed79254feb1d9676c</span><br><span class="line">.... 省略了大量行 ...</span><br><span class="line">100644 blob 170da7b0e607c4fd6fb4e921d76307397ab89c1e    2019-02-17-organizing-this-blog-into-categories.markdown</span><br><span class="line">100644 blob 7d4f27e9804e3dc80ab3a3912b4f1c890c4d2432    2019-03-15-new-zine--bite-size-networking-.markdown</span><br><span class="line">100644 blob 0d1b9fbc7896e47da6166e9386347f9ff58856aa    2019-03-26-what-are-monoidal-categories.markdown</span><br><span class="line">100644 blob d6949755c3dadbc6fcbdd20cc0d919809d754e56    2019-06-23-a-few-debugging-resources.markdown</span><br><span class="line">100644 blob 3105bdd067f7db16436d2ea85463755c8a772046    2019-06-28-brag-doc.markdown &lt;-- 我们找到了！！！</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在此，<code>2019-06-28-brag-doc.markdown</code> 之所以位于列表最后，是因为在发布时它是最新的博文。</p><h3 id="查看提交的第五步：我们终于找到它！"><a href="#查看提交的第五步：我们终于找到它！" class="headerlink" title="查看提交的第五步：我们终于找到它！"></a>查看提交的第五步：我们终于找到它！</h3><p>经过努力，我们找到了博文历史版本所在的对象文件！太棒了！它的哈希值是 <code>3105bdd067f7db16436d2ea85463755c8a772046</code>，因此它位于 <code>git/objects/31/05bdd067f7db16436d2ea85463755c8a772046</code>。</p><p>我们可以使用 <code>decompress.py</code> 来查看它：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python3 decompress.py .git/objects/31/05bdd067f7db16436d2ea85463755c8a772046 | head</span><br><span class="line">blob 15924---</span><br><span class="line">title: &quot;Get your work recognized: write a brag document&quot;</span><br><span class="line">date: 2019-06-28T18:46:02Z</span><br><span class="line">url: /blog/brag-documents/</span><br><span class="line">categories: []</span><br><span class="line">---</span><br><span class="line">... 文件的剩余部分在此 ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这就是博文的旧版本！如果我执行命令 <code>git checkout 026c0f52 content/post/2019-06-28-brag-doc.markdown</code> 或者 <code>git restore --source 026c0f52 content/post/2019-06-28-brag-doc.markdown</code>，我就会获取到这个版本。</p><h3 id="这样遍历树就是-git-log-的运行机制"><a href="#这样遍历树就是-git-log-的运行机制" class="headerlink" title="这样遍历树就是 git log 的运行机制"></a>这样遍历树就是 git log 的运行机制</h3><p>我们刚刚经历的整个过程（找到提交、逐层遍历目录树、搜索所需文件名）看似繁琐，但实际上当我们执行 <code>git log content/post/2019-06-28-brag-doc.markdown</code> 时，背后就是这样在运行。它需要逐个检查你历史记录中的每一个提交，在每个提交中核查 <code>content/post/2019-06-28-brag-doc.markdown</code> 的版本（例如在这个案例中为 <code>3105bdd067f7db16436d2ea85463755c8a772046</code>），并查看它是否自上一提交以来有所改变。</p><p>这就是为什么有时 <code>git log FILENAME</code> 会执行的有些缓慢 —— 我的这个仓库中有 3000 个提交，它需要对每个提交做大量的工作，来判断该文件是否在该提交中发生过变化。</p><h3 id="我有多少个历史版本的文件？"><a href="#我有多少个历史版本的文件？" class="headerlink" title="我有多少个历史版本的文件？"></a>我有多少个历史版本的文件？</h3><p>目前，我在我的博客仓库中跟踪了 1530 个文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git ls-files | wc -l</span><br><span class="line">1530</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但历史文件有多少呢？我们可以列出 <code>.git/objects</code> 中所有的内容，看看有多少对象文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects/ -type f | grep -v pack | awk -F/ &#x27;&#123;print $3 $4&#125;&#x27; | wc -l</span><br><span class="line">20135</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但并不是所有这些都代表过去版本的文件 —— 正如我们之前所见，许多都是提交和目录树。不过，我们可以编写一个小小的 Python 脚本 <code>find-blobs.py</code>，遍历所有对象并检查是否以 <code>blob</code> 开头：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import zlib</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">for line in sys.stdin:</span><br><span class="line">    line = line.strip()</span><br><span class="line">    filename = f&quot;.git/objects/&#123;line[0:2]&#125;/&#123;line[2:]&#125;&quot;</span><br><span class="line">    with open(filename, &quot;rb&quot;) as f:</span><br><span class="line">        contents = zlib.decompress(f.read())</span><br><span class="line">        if contents.startswith(b&quot;blob&quot;):</span><br><span class="line">            print(line)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects/ -type f | grep -v pack | awk -F/ &#x27;&#123;print $3 $4&#125;&#x27; | python3 find-blobs.py | wc -l</span><br><span class="line">6713</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>于是，看起来在我的 Git 仓库中存放的旧文件版本有 <code>6713 - 1530 = 5183</code> 个，Git 会为我保存这些文件，以备我想着要恢复它们时使用。太好了！</p><h3 id="就这些啦！"><a href="#就这些啦！" class="headerlink" title="就这些啦！"></a>就这些啦！</h3><p>在 <a target="_blank" rel="noopener" href="https://gist.github.com/jvns/ff884dceef7660402fe1eca697cfbf51">这个 gist</a> 中附上了全部的此篇文章所用代码，其实没多少。</p><p>我以为我已经对 Git 的工作方式了如指掌，但我以前从未真正涉及过打包文件，所以这次探索很有趣。我也很少思考当我让 <code>git log</code> 跟踪一个文件的历史时，它实际上有多大的工作量，因此也很开心能深入研究这个。</p><p>作为一个有趣的后续：我提交这篇博文后，Git 就警告我仓库中的对象太多（我猜 20,000 太多了！），并运行 <code>git gc</code> 将它们全部压缩成打包文件。所以现在我的 <code>.git/objects</code> 目录已经被压缩得十分小了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find .git/objects/ -type f | wc -l</span><br><span class="line">14</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><em>（题图：MJ&#x2F;319a396c-6f3f-4891-b051-261312c8ea9a）</em></p><hr><p>via: <a target="_blank" rel="noopener" href="https://jvns.ca/blog/2023/09/14/in-a-git-repository--where-do-your-files-live-/">https://jvns.ca/blog/2023/09/14/in-a-git-repository--where-do-your-files-live-/</a></p><p>作者：<a target="_blank" rel="noopener" href="https://jvns.ca/">Julia Evans</a> 选题：<a target="_blank" rel="noopener" href="https://github.com/lujun9972">lujun9972</a> 译者：ChatGPT 校对：<a target="_blank" rel="noopener" href="https://github.com/wxy">wxy</a></p><p>本文由 <a target="_blank" rel="noopener" href="https://github.com/LCTT/TranslateProject">LCTT</a> 原创编译，<a target="_blank" rel="noopener" href="https://linux.cn/">Linux中国</a> 荣誉推出</p></div></div></div><div class="footer"><p class="footer-copyright"><span>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></span> <span>Theme <a target="_blank" href="https://github.com/tinkink-co/hexo-theme-terminal">Terminal</a></span><script type="text/javascript" src="https://cdn.staticfile.net/jquery/3.4.1/jquery.min.js"></script><script>getCDNinfo=function(){$.ajax({url:"/cdn-cgi/trace",success:function(a,n){let i="Antananarivo, Madagascar - (TNR);Cape Town, South Africa - (CPT);Casablanca, Morocco - (CMN);Dar Es Salaam, Tanzania - (DAR);Djibouti City, Djibouti - (JIB);Durban, South Africa - (DUR);Johannesburg, South Africa - (JNB);Kigali, Rwanda - (KGL);Lagos, Nigeria - (LOS);Luanda, Angola - (LAD);Maputo, MZ - (MPM);Mombasa, Kenya - (MBA);Port Louis, Mauritius - (MRU);Réunion, France - (RUN);Bangalore, India - (BLR);Bangkok, Thailand - (BKK);Bandar Seri Begawan, Brunei - (BWN);Cebu, Philippines - (CEB);Chengdu, China - (CTU);Chennai, India - (MAA);Chittagong, Bangladesh - (CGP);Chongqing, China - (CKG);Colombo, Sri Lanka - (CMB);Dhaka, Bangladesh - (DAC);Dongguan, China - (SZX);Foshan, China - (FUO);Fuzhou, China - (FOC);Guangzhou, China - (CAN);Hangzhou, China - (HGH);Hanoi, Vietnam - (HAN);Hengyang, China - (HNY);Ho Chi Minh City, Vietnam - (SGN);Hong Kong - (HKG);Hyderabad, India - (HYD);Islamabad, Pakistan - (ISB);Jakarta, Indonesia - (CGK);Jinan, China - (TNA);Karachi, Pakistan - (KHI);Kathmandu, Nepal - (KTM);Kolkata, India - (CCU);Kuala Lumpur, Malaysia - (KUL);Lahore, Pakistan - (LHE);Langfang, China - (NAY);Luoyang, China - (LYA);Macau - (MFM);Malé, Maldives - (MLE);Manila, Philippines - (MNL);Mumbai, India - (BOM);Nagpur, India - (NAG);Nanning, China - (NNG);New Delhi, India - (DEL);Osaka, Japan - (KIX);Phnom Penh, Cambodia - (PNH);Qingdao, China - (TAO);Seoul, South Korea - (ICN);Shanghai, China - (SHA);Shenyang, China - (SHE);Shijiazhuang, China - (SJW);Singapore, Singapore - (SIN);Suzhou, China - (SZV);Taipei - (TPE);Thimphu, Bhutan - (PBH);Tianjin, China - (TSN);Tokyo, Japan - (NRT);Ulaanbaatar, Mongolia - (ULN);Vientiane, Laos - (VTE);Wuhan, China - (WUH);Wuxi, China - (WUX);Xi'an, China - (XIY);Yerevan, Armenia - (EVN);Zhengzhou, China - (CGO);Zuzhou, China - (CSX);Amsterdam, Netherlands - (AMS);Athens, Greece - (ATH);Barcelona, Spain - (BCN);Belgrade, Serbia - (BEG);Berlin, Germany - (TXL);Brussels, Belgium - (BRU);Bucharest, Romania - (OTP);Budapest, Hungary - (BUD);Chișinău, Moldova - (KIV);Copenhagen, Denmark - (CPH);Cork, Ireland -  (ORK);Dublin, Ireland - (DUB);Düsseldorf, Germany - (DUS);Edinburgh, United Kingdom - (EDI);Frankfurt, Germany - (FRA);Geneva, Switzerland - (GVA);Gothenburg, Sweden - (GOT);Hamburg, Germany - (HAM);Helsinki, Finland - (HEL);Istanbul, Turkey - (IST);Kyiv, Ukraine - (KBP);Lisbon, Portugal - (LIS);London, United Kingdom - (LHR);Luxembourg City, Luxembourg - (LUX);Madrid, Spain - (MAD);Manchester, United Kingdom - (MAN);Marseille, France - (MRS);Milan, Italy - (MXP);Moscow, Russia - (DME);Munich, Germany - (MUC);Nicosia, Cyprus - (LCA);Oslo, Norway - (OSL);Paris, France - (CDG);Prague, Czech Republic - (PRG);Reykjavík, Iceland - (KEF);Riga, Latvia - (RIX);Rome, Italy - (FCO);Saint Petersburg, Russia - (LED);Sofia, Bulgaria - (SOF);Stockholm, Sweden - (ARN);Tallinn, Estonia - (TLL);Thessaloniki, Greece - (SKG);Vienna, Austria - (VIE);Vilnius, Lithuania - (VNO);Warsaw, Poland - (WAW);Zagreb, Croatia - (ZAG);Zürich, Switzerland - (ZRH);Arica, Chile - (ARI);Asunción, Paraguay - (ASU);Bogotá, Colombia - (BOG);Buenos Aires, Argentina - (EZE);Curitiba, Brazil - (CWB);Fortaleza, Brazil - (FOR);Guatemala City, Guatemala - (GUA);Lima, Peru - (LIM);Medellín, Colombia - (MDE);Panama City, Panama - (PTY);Porto Alegre, Brazil - (POA);Quito, Ecuador - (UIO);Rio de Janeiro, Brazil - (GIG);São Paulo, Brazil - (GRU);Santiago, Chile - (SCL);Willemstad, Curaçao - (CUR);St. George's, Grenada - (GND);Amman, Jordan - (AMM);Baghdad, Iraq - (BGW);Baku, Azerbaijan - (GYD);Beirut, Lebanon - (BEY);Doha, Qatar - (DOH);Dubai, United Arab Emirates - (DXB);Kuwait City, Kuwait - (KWI);Manama, Bahrain - (BAH);Muscat, Oman - (MCT);Ramallah - (ZDM);Riyadh, Saudi Arabia - (RUH);Tel Aviv, Israel - (TLV);Ashburn, VA, United States - (IAD);Atlanta, GA, United States - (ATL);Boston, MA, United States - (BOS);Buffalo, NY, United States - (BUF);Calgary, AB, Canada - (YYC);Charlotte, NC, United States - (CLT);Chicago, IL, United States - (ORD);Columbus, OH, United States - (CMH);Dallas, TX, United States - (DFW);Denver, CO, United States - (DEN);Detroit, MI, United States - (DTW);Honolulu, HI, United States - (HNL);Houston, TX, United States - (IAH);Indianapolis, IN, United States - (IND);Jacksonville, FL, United States - (JAX);Kansas City, MO, United States - (MCI);Las Vegas, NV, United States - (LAS);Los Angeles, CA, United States - (LAX);McAllen, TX, United States - (MFE);Memphis, TN, United States - (MEM);Mexico City, Mexico - (MEX);Miami, FL, United States - (MIA);Minneapolis, MN, United States - (MSP);Montgomery, AL, United States - (MGM);Montréal, QC, Canada - (YUL);Nashville, TN, United States - (BNA);Newark, NJ, United States - (EWR);Norfolk, VA, United States - (ORF);Omaha, NE, United States - (OMA);Philadelphia, United States - (PHL);Phoenix, AZ, United States - (PHX);Pittsburgh, PA, United States - (PIT);Port-Au-Prince, Haiti - (PAP);Portland, OR, United States - (PDX);Queretaro, MX, Mexico - (QRO);Richmond, Virginia - (RIC);Sacramento, CA, United States - (SMF);Salt Lake City, UT, United States - (SLC);San Diego, CA, United States - (SAN);San Jose, CA, United States - (SJC);Saskatoon, SK, Canada - (YXE);Seattle, WA, United States - (SEA);St. Louis, MO, United States - (STL);Tampa, FL, United States - (TPA);Toronto, ON, Canada - (YYZ);Vancouver, BC, Canada - (YVR);Tallahassee, FL, United States - (TLH);Winnipeg, MB, Canada - (YWG);Adelaide, SA, Australia - (ADL);Auckland, New Zealand - (AKL);Brisbane, QLD, Australia - (BNE);Melbourne, VIC, Australia - (MEL);Noumea, New caledonia - (NOU);Perth, WA, Australia - (PER);Sydney, NSW, Australia - (SYD)".split(";"),e=a.split("colo=")[1].split("\n")[0],t=(a.split("colo=")[1].split("\n")[0],a.split("tls=")[1].split("\n")[0]),o=a.split("http=")[1].split("\n")[0],s=a.split("sni=")[1].split("\n")[0],r=a.split("ip=")[1].split("\n")[0],l=a.split("uag=")[1].split("\n")[0];for(var d=0;d<i.length;d++)if(-1!=i[d].indexOf(e)){document.getElementById("cdn").innerHTML=i[d];break}document.getElementById("tls").innerHTML=t,document.getElementById("http").innerHTML=o,document.getElementById("sni").innerHTML=s,document.getElementById("ip").innerHTML=r,document.getElementById("useragent").innerHTML=l}})},$(document).ready((function(){getCDNinfo()}))</script></p><p style="text-align:center">感谢陪伴与布道，开源之火不灭。​</p><p style="text-align:center"><script>document.write("本次加载耗时: "+(performance.getEntriesByType("navigation").reduce((e,r)=>e+r.responseEnd-r.startTime,0)+performance.getEntriesByType("resource").reduce((e,r)=>e+r.responseEnd-r.startTime,0)).toFixed(0)+"ms")</script></p><p style="text-align:center">当前 SNI 状态： <span id="sni">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 TLS 版本： <span id="tls">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前 HTTP 版本： <span id="http">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前您的客户端 IP 是： <span id="ip">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">当前分配的 CDN 节点是: <span id="cdn">正在统计！或可能被浏览器防追踪拦截！</span></p><p style="text-align:center">您的 UserAgent 信息是: <span id="useragent">正在统计！或可能被浏览器防追踪拦截！</span></p><p></p></div></div></body></html>